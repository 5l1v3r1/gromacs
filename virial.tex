\section{Single Sum Virial in {\gromacs}.}
\label{sec:virial}
The virial $\Xi$ can be written in full tensor form as:
\beq
\Xi~=~-\half~\sum_{i < j}^N~\rvij\otimes\Fvij
\eeq
where $\otimes$ denotes the {\em direct product} of two vectors\footnote
{$({\bf u}\otimes{\bf v})^{\ab}~=~{\bf u}_{\al}{\bf v}_{\be}$}. When this is 
computed in the inner loop of an MD program 9 multiplications and 9
additions are needed\footnote{The calculation of 
Lennard-Jones and Coulomb forces is about 50 floating point operations.}.

Here it is shown how it is possible to extract the virial calculation
from the inner loop and also how the pressure is calculated in {\gromacs}.

\subsection{Virial.}
In a periodic system the (Periodic Boundary Conditions) PBC must be taken into account for the virial:
\beq
\Xi~=~-\half~\sum_{i < j}^{N}~\rnij\otimes\Fvij
\eeq
where $\rnij$ denotes the distance vector of the
{\em nearest image} of atom $i$ from atom $j$. In this definition we add
a {\em shift vector} $\delta_i$ to the position vector $\rvi$ 
of atom $i$. The difference vector $\rnij$ is thus equal to:
\beq
\rnij~=~\rvi+\delta_i-\rvj
\eeq
or in shorthand:
\beq
\rnij~=~\rni-\rvj
\eeq
In a triclinic system there are 27 possible images of $i$, when truncated 
octahedron is used there are 15 possible images.

\subsection{Virial from non-bonded forces.}
Here the derivation for the single sum virial in the {\em non-bonded force} 
routine is given. $i \neq j$ in all formulae below.
\newcommand{\di}{\delta_{i}}
\newcommand{\qrt}{\frac{1}{4}}
\bea
\Xi	
&~=~&-\half~\sum_{i < j}^{N}~\rnij\otimes\Fvij				\\
&~=~&-\qrt\sum_{i=1}^N~\sum_{j=1}^N ~(\rvi+\di-\rvj)\otimes\Fvij	\\
&~=~&-\qrt\sum_{i=1}^N~\sum_{j=1}^N ~(\rvi+\di)\otimes\Fvij-\rvj\otimes\Fvij	\\
&~=~&-\qrt\left(\sum_{i=1}^N~\sum_{j=1}^N ~(\rvi+\di)\otimes\Fvij~-~\sum_{i=1}^N~\sum_{j=1}^N ~\rvj\otimes\Fvij\right)	\\
&~=~&-\qrt\left(\sum_{i=1}^N~(\rvi+\di)\otimes\sum_{j=1}^N~\Fvij~-~\sum_{j=1}^N ~\rvj\otimes\sum_{i=1}^N~\Fvij\right)	\\
&~=~&-\qrt\left(\sum_{i=1}^N~(\rvi+\di)\otimes\Fvi~+~\sum_{j=1}^N ~\rvj\otimes\Fvj\right)	\\
&~=~&-\qrt\left(2~\sum_{i=1}^N~\rvi\otimes\Fvi+\sum_{i=1}^N~\di\otimes\Fvi\right)
\eea
In these formulae we introduced
\bea
\Fvi&~=~&\sum_{j=1}^N~\Fvij					\\
\Fvj&~=~&\sum_{i=1}^N~\Fvji
\eea
which is the total force on $i$ resp. $j$. Because we use Newtons third law
\beq
\Fvij~=~-\Fvji
\eeq
we must in the implementation double the term containing the shift $\delta_i$.

\subsection{The intramolecular shift (mol-shift).}
For the bonded-forces and shake it is possible to make a {\em mol-shift}
list, in which the periodicity is stored. We simple have an array {\tt mshift}
in which for each atom an index in the {\tt shiftvec} array is stored.

The algorithm to generate such a list can be derived from graph theory,
considering each particle in a molecule as a bead in a graph, the bonds 
as edges.
\begin{enumerate}
\item[1]	represent the bonds and atoms as bidirectional graph
\item[2]	make all atoms white
\item[3]	make one of the white atoms black (atom $i$) and put it in the
		central box
\item[4]	make all of the neighbors of $i$ that are currently 
		white, grey 
\item[5]	pick one of the grey atoms (atom $j$), give it the
		correct periodicity with respect to any of 
		its black neighbors
		and make it black
\item[6]	make all of the neighbors of $j$ that are currently 
		white, grey
\item[7]	if any grey atom remains, goto [5]
\item[8]	if any white atom remains, goto [3]
\end{enumerate}
Using this algorithm we can 
\begin{itemize}
\item	optimise the bonded force calculation as well as shake
\item	calculate the virial from the bonded forces
	in the single sum way again
\end{itemize}

Find a representation of the bonds as a bidirectional graph.

\subsection{Virial from Covalent Bonds.}
The covalent bond force gives a contribution to the virial, we have
\bea
b	&~=~&	\|\rnij\|					\\
V_b	&~=~&	\half k_b(b-b_0)^2				\\
\Fvi	&~=~&	-\nabla V_b					\\
	&~=~&	k_b(b-b_0)\frac{\rnij}{b}			\\
\Fvj	&~=~&	-\Fvi
\eea
The virial contribution from the bonds then is
\bea
\Xi_b	&~=~&	-\half(\rni\otimes\Fvi~+~\rvj\otimes\Fvj)	\\
	&~=~&	-\half\rnij\otimes\Fvi
\eea

\subsection{Virial from Shake.}
An important contribution to the virial comes from shake. Satisfying 
the constraints a force {\bf G} is exerted on the particles shaken. If this
force does not come out of the algorithm (as in standard shake) it can be
calculated afterwards (when using {\em leap-frog}) by:
\bea
\Delta\rvi&~=~&\rvi(t+\Dt)-
[\rvi(t)+{\bf v}_i(t-\frac{\Dt}{2})\Dt+\frac{\Fvi}{m_i}\Dt^2]	\\
{\bf G}_i&~=~&\frac{m_i\Delta\rvi}{\Dt^2}
\eea
but this does not help us in the general case. Only when no periodicity
is needed (like in rigid water) this can be used, otherwise
we must add the virial calculation in the inner loop of shake.

When it {\em is} applicable the virial can be calculated in the single sum way:
\beq
\Xi~=~-\half\sum_i^{N_c}~\rvi\otimes\Fvi
\eeq
where $N_c$ is the number of constrained atoms.

%Another method is the Non-Iterative shake as proposed (and implemented)
%by Yoneya. In this algorithm the Lagrangian multipliers are solved in a 
%matrix equation, and given these multipliers it is easy to get the periodicity
%in the virial afterwards. 

%More...

