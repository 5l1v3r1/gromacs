\chapter{Special Topics}
\label{ch:special}
\section{\normindex{NMR} refinement}
The {\gromacs} software can be used to do NMR structure refinements.
A list of distance restrains based on NOE data can be added in your
topology file, like in the following example:
\begin{verbatim}
[ distance_restraints ]
; ai    aj      type    index   type'   low      up1     up2     fac
10      16      1       0       1       0.0      0.3     0.4     1.0 
10      28      1       1       1       0.0      0.3     0.4     1.0 
10      46      1       1       1       0.0      0.3     0.4     1.0 
16      22      1       2       1       0.0      0.3     0.4     2.5 
16      34      1       3       1       0.0      0.5     0.6     1.0 
\end{verbatim}
In this example a number of features can be found.
In columns {\tt ai} and {\tt aj} you find the atom numbers of the
particles to be restrained. The {\tt type} column should always be 1.
As explained in ~\secref{disre}, multiple distances can add
to a single NOE signal. In the topology this can be set using the
{\tt index} column. In our example, the restraints 10-28 and 10-46
both have index 1, therefore they are treated simultaneously.
An extra requirement for treating restraints together, is that 
the restraints should be on successive lines, without any
other intervening restraint. The columns {\tt low}, {\tt up1} and {\tt up2}
hold the values of $r_0$, $r_1$ and $r_2$ from ~\eqnref{disre}.
In some cases in can be useful to have different force constants for
some restraints, this is controlled by the column {\tt fac}.
The force constant in the parameter file is multiplied by the value in the
column {\tt fac} for each restraint.
The columns {\tt type'} and {\tt low} hold variables, which are as of yet 
not used. They must be specified in the topology file however.

Some paramerts for NMR refinement using can be specified in the
{\tt grompp.mdp} file:
\begin{description}
\item[{\tt disre}: type of distance restraining.]
	The {\tt disre} variable sets the type of distance restraining.
	{\tt no/simple} turns the distance restraining off/on.
 	When multiple proteins or peptides are used
	in the simulation ensemble averaging 
	can be turned on by setting {\tt disre = ensemble}.
\item[{\tt disre\_weighting}: force-weighting in restraints with
	 multiple pairs.]
	The distance restraint force can be distributed equally
	over all the pairs involved in the restraint by setting
	{\tt disre\_weighting = equal}.
	The option {\tt disre\_weighting = conservative}
	gives conservative forces when {\tt disre\_tau = 0}.
	See ~\secref{disre} for details.
\item[{\tt disre\_mixed}: how to calculate the violations.]
	{\tt disre\_mixed = no} gives normal running time
	averaged violations.
	When {\tt disre\_mixed = yes} the square root of the
	product of the running time averaged and the instantaneous
	violations is used.
	See ~\secref{disre} for details.
\item[{\tt disre\_fc}: force constant $k_{dr}$ for distance restraints.] 
	$k_{dr}$  (\eqnref{disre}) can be set
	as variable {\tt disre\_fc = 1000} for a force constant of
	1000 {kJ mol$^{-1}$ nm$^{-2}$}. This value is multiplied by
	the value in the {\tt fac} column in the distance restraint
	entries in the topology file.
\item[{\tt disre\_tau}: time constant for restraints.] 
	$\tau$ (\eqnref{ravdisre}) can be set
	as variable {\tt disre\_tau = 10} for a time constant of
	10 ps.
\item[{\tt nstdisreout}: pair distance output frequency.]
	Determines how often the running time averaged and 
	instantaneous distances of all atom pairs involved in
	distance restraints are written to the energy file.
\end{description}

\newcommand{\amine}{\sf -NH$_2$}
\newcommand{\amines}{\sf -NH-}
\newcommand{\aminep}{\sf -NH$_3^+$}
\section{Removing fastest \myindex{degrees of freedom}}
The maximum time step in MD simulations is limited by the smallest
oscillation period that can be found in the simulated
system. Bond-stretching vibrations are in their quantum-mechanical
ground state and are therefore better represented by a constraint than
by a harmonic potential.

For the remaining degrees of freedom, the shortest oscillation period
as measured from a simulation is 13~fs for bond-angle vibrations
involving hydrogen atoms. Taking as a guideline that with a Verlet
(leap-frog) integration scheme a minimum of 5 numerical integration
steps should be performed per period of a harmonic oscillation in
order to integrate it with reasonable accuracy, the maximum time step
will be about 3~fs. Disregarding these very fast oscillations of
period 13~fs the next shortest periods are around 20~fs, which will
allow a maximum time step of about 4~fs

Removing the bond-angle degrees of freedom from hydrogen atoms can
best be done by defining them as \myindex{dummy atoms} in stead of
normal atoms. Where a normal atoms is connected to the molecule with
bonds, angles and dihedrals, a dummy atom's position is calculated
from the position of three nearby heavy atoms in a predefined manner
(see also ~\secref{dummy}). For the hydrogens in water and in
hydroxyl, sulfhydryl or amine groups, no degrees of freedom can be
removed, because rotational freedom should be preserved. The only
other option available to slow down these motions, is to increase the
mass of the hydrogen atoms at the expense of the mass of the connected
heavy atom. This will increase the moment of inertia of the water
molecules and the hydroxyl, sulfhydryl or amine groups, without
affecting the equilibrium properties of the system and without
affecting the dynamical properties too much. These constructions will
shortly be described in~sub\secref{dummyhydro} and have previously
been described in full detail~\cite{feenstra99}.

Using both dummy atoms and \myindex{modified masses}, the next
bottleneck is likely to be formed by the improper dihedrals (which are
used to preserve planarity or chirality of molecular groups) and the
peptide dihedrals. The peptide dihedral cannot be changed without
affecting the physical behavior of the protein. The improper dihedrals
that preserve planarity, mostly deal with aromatic residues. Bonds,
angles and dihedrals in these residues can also be replaced with
somewhat elaborate dummy atom constructions, as will be described in
sub~\secref{dummyaro}.

All modifications described in this section can be performed using the
{\gromacs} topology building tool {\tt \myindex{pdb2gmx}}. Separate
options exist to increase hydrogen masses, dummify all hydrogen atoms
or also dummify all aromatic residues. Note that when all hydrogen
atoms are dummified, also those inside the aromatic residues will be
dummified, i.e. hydrogens in the aromatic residues are treated
differently depending on the treatment of the aromatic residues.

Parameters for the dummy constructions for the hydrogen atoms are
inferred from the forcefield parameters ({\em vis}. bondlengths and
angles) directly by {\tt \myindex{grompp}} while processing the
topology file.  The constructions for the aromatic residues are based
on the bondlengths and angles for the geometry as described in the
forcefiels, but these parameters are hard-coded into {\tt
\myindex{pdb2gmx}} due to the complex nature of the construction
needed for a whole aromatic group.

\subsection{Hydrogen bond-angle vibrations}
\label{sec:dummyhydro}
\subsubsection{Construction of Dummy Atoms} %%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}
\centerline{\psfig{figure=plots/dumtypes.eps,width=11cm}}
\caption[Schematic view of the different types of dummy atom
constructions used for hydrogen atoms.]{Schematic view of the
different types of dummy atom constructions used for hydrogen
atoms. The atoms used in the construction of the dummy atom(s) are
depicted as black circles, dummy atoms as grey ones. Hydrogens are
smaller than heavy atoms. {\sf A}: fixed bond angle, note that here
the hydrogen is not a dummy atom; {\sf B}: in the plane of three
atoms, with fixed distance; {\sf C}: in the plane of three atoms, with
fixed angle and distance; {\sf D}: construction for amine groups
({\amine} or {\aminep}), see text for details.}
\label{fig:dumhydro}
\end{figure}

The goal of defining hydrogen atoms as dummy atoms is to remove all
high-frequency degrees of freedom from them. In some cases not all
degrees of freedom of a hydrogen atom should be removed, e.g. in the
case of hydroxyl or amine groups the rotational freedom of the
hydrogen atom(s) should be preserved. Care should be taken that no
unwanted correlations are introduced by the construction of dummy
atoms, e.g. bond-angle vibration between the constructing atoms could
translate into hydrogen bond-length vibration. Additionally, since
dummy atoms are by definition mass-less, in order to preserve total
system mass, the mass of each hydrogen atom that is treated as dummy
atom should be added to the bonded heavy atom.

Taking into account these considerations, the hydrogen atoms in a
protein naturally fall into several categories, each requiring a
different approach, see also \figref{dumhydro}:

\begin{itemize}

\item{\em hydroxyl ({\sf -OH}) or sulfhydryl ({\sf -SH})
hydrogen:\/} The only internal degree of freedom in a hydroxyl group
that can be constrained is the bending of the {\sf C-O-H} angle. This
angle is fixed by defining an additional bond of appropriate length,
see \figref{dumhydro}A. This removes the high frequency angle bending,
but leaves the dihedral rotational freedom. The same goes for a
sulfhydryl group. Note that in these cases the hydrogen is not treated
as a dummy atom.

\item{\em single amine or amide ({\amines}) and aromatic hydrogens
({\sf -CH-}):\/} The position of these hydrogens cannot be constructed
from a linear combination of bond vectors, because of the flexibility
of the angle between the heavy atoms. In stead, the hydrogen atom is
positioned at a fixed distance from the bonded heavy atom on a line
going through the bonded heavy atom and a point on the line through
both second bonded atoms, see \figref{dumhydro}B.

\item{\em planar amine ({\amine}) hydrogens:\/} The method used for
the single amide hydrogen is not well suited for planar amine groups,
because no suitable two heavy atoms can be found to define the
direction of the hydrogen atoms. In stead, the hydrogen is constructed
at a fixed distance from the nitrogen atom, with a fixed angle to the
carbon atom, in the plane defined by one of the other heavy atoms, see
\figref{dumhydro}C.

\item{\em amine group (umbrella {\amine} or {\aminep}) hydrogens:\/}
Amine hydrogens with rotational freedom cannot be constructed as dummy
atoms from the heavy atoms they are connected to, since this would
result in loss of the rotational freedom of the amine group. To
preserve the rotational freedom while removing the hydrogen bond-angle
degrees of freedom, two ``dummy masses'' are constructed with the same
total mass, moment of inertia (for rotation around the {\sf C-N} bond)
and center of mass as the amine group. These dummy masses have no
interaction with any other atom, except for the fact that they are
connected to the carbon and to each other, resulting in a rigid
triangle. From these three particles the positions of the nitrogen and
hydrogen atoms are constructed as linear combinations of the two
carbon-mass vectors and their outer product, resulting in an amine
group with rotational freedom intact, but without other internal
degrees of freedom. See \figref{dumhydro}D.

\end{itemize}

\begin{figure}
\centerline{\psfig{figure=plots/dumaro.eps,width=15cm}}
\caption[Schematic view of the different types of dummy atom
constructions used for aromatic residues.]{Schematic view of the
different types of dummy atom constructions used for aromatic
residues. The atoms used in the construction of the dummy atom(s) are
depicted as black circles, dummy atoms as grey ones. Hydrogens are
smaller than heavy atoms. {\sf A}: phenylalanine; {\sf B}: tyrosine
(note that the hydroxyl hydrogen is {\em not} a dummy atom); {\sf C}:
tryptophane; {\sf D}: histidine.}
\label{fig:dumaro}
\end{figure}

\subsection{Out-of-plane vibrations in aromatic groups}
\label{sec:dummyaro}
The planar arrangements in the sidechains of the aromatic residues,
lends itself perfectly for a dummy-atom construction, giving a
perfectly planar group without the inherently instable constraints
that are necessary to keep normal atoms in a plane. The basic approach
is to define three atoms or dummy masses with constraints between them
to fix the geometry and create the rest of the atoms as simple dummy
type 3 atoms (see section~\secref{dummy}) from these three. Each of
the aromatic residues require a different approach:

\begin{itemize}

\item{\em Phenylalanine:\/} {\sf C}$_\gamma$, {\sf C}$_{{\epsilon}1}$
and {\sf C}$_{{\epsilon}2}$ are kept as normal atoms, but with each a
mass of one third the total mass of the phenyl group. See
\figref{dumhydro}A.

\item{\em Tyrosine:\/} The ring is treated identical to the
phenylalanine ring. Additionally, constraints are defined between {\sf
C}$_{{\epsilon}1}$ and {\sf C}$_{{\epsilon}2}$ and {\sf O}$_{\eta}$.
The original improper dihedral angles will keep both triangles (one
for the ring and one with {\sf O}$_{\eta}$) in a plane, but due to the
larger moments of inertia this construction will be much more
stable. The bond angle in the hydroxyl group will be constrained by a
constraint between {\sf C}$_\gamma$ and {\sf H}$_{\eta}$, note that
the hydrogen is not treated as a dummy atom. See
\figref{dumhydro}B.

\item{\em Tryptophane:\/} {\sf C}$_\beta$ is kept as a normal atom
and two dummy masses are created at the center of mass of each of the
rings, each with a mass equal to the total mass of the respective ring
({\sf C}$_{{\delta}2}$ and {\sf C}$_{{\epsilon}2}$ are each
counted half for each ring). This keeps the overall center of mass and
the moment of inertia almost (but not quite) equal to what it was. See
\figref{dumhydro}C.

\item{\em Histidine:\/} {\sf C}$_\gamma$, {\sf C}$_{{\epsilon}1}$
and {\sf N}$_{{\epsilon}2}$ are kept as normal atoms, but with masses
redistributed such that the center of mass of the ring is
preserved. See \figref{dumhydro}D.

\end{itemize}

\section{Running with PVM.}
If you have a parallel computer, it may be equipped with PVM (Parallel
Virtual Machines, see also chapter~\ref{ch:algorithms}), otherwise,
have your system administrator install it. The package is public
domain software and supports virtually every commercially available
computer, such as an SGI Power Challenge, Paragon {\intel} box,
Thinking machines CM-5, CRAY-J9036287, Convex MPP, etc., or on a
cluster of workstations.

The {\gromacs} software can work with the PVM library, but only
on computers with the same processor, it is not possible to mix
eg. Sparc and MIPS chips. We will assume
here that the software is installed with PVM. A sample PVM session
is described below.

First, set the PVM environment variables in your {\tt .cshrc} file.
\begin{verbatim}
setenv	PVM_ROOT=/home/pvm
setenv	PVM_ARG=SGI
\end{verbatim}
You also need access to a number of workstations, let's call them
{\bf vince}, {\bf butch} and {\bf mia}, we'll assume your username
is {\bf wallace}. Make a {\tt .rhosts} file in your home directory:
\begin{verbatim}
vince   wallace
butch   wallace
mia     wallace
\end{verbatim}
Now log off and on again to effectuate all this (assuming you are sitting on 
{\tt vince}). Start the pvm front-end: 
\begin{verbatim}
% pvm
pvm>add butch mia
2 successful
                    HOST     DTID
                   vince    80000
                     mia   100000
pvm>quit

pvmd still running.
%
\end{verbatim}
Now you can use {\gromacs} with pvm. You just have to add the option
{\tt -N 3} to your {\tt grompp} and {\tt mdrun} command lines. Since the
remotely running mdruns will start from your home directory, give a full 
path for the log file, eg.: {\tt -g /data/pulp/wallace/speptide/md}.

PVM jobs can be stopped within the pvm command line utility with
{\tt kill process}. All pvms can be terminated with the {\tt halt} command.

\section{Running with MPI}
If you have installed the MPI (Message Passing Interface) on your computer(s)
you can compile {\gromacs} with this communication library. Some
hardware vendors provide optimized MPI libraries for shared-memory
architectures, or whatever is fast on their particular platform.
Compiling the {\gromacs} distribution with MPI support is straightforward.
Edit your {\tt Makefile.\$CPU} in the {\tt gmxhome/src/makef} directory,
and set the {\tt USE\_MPI} variable to {\tt yes} and recompile all sources.
If all is well, you can now run with MPI. 

There usually is a program called {\tt mpirun} with which you can fire
up the parallel processes. A typical command line looks like:
\type{mpirun -p goofus,doofus,fred 10 mdrun -s topol -v -N 30}
this runs on each of the machines goofus,doofus,fred with 10 processes
on each\footnote{This example taken from Silicon Graphics manual}.

If you have a single machine with multiple processors you don't have to
use the {\tt mpirun} command, but you can do with an extra option to
{\tt mdrun}:
\type{mdrun -np 8 -s topol -v -N 8}
In this example MPI reads the first option from the command line.
Since {\tt mdrun} also wants to know the number of processes you have to
type it twice.
Please note that no automatic nicing is done, which means that only
the first process will be niced by default. 
Check your local manuals (or online manual) for exact details
of your MPI implementation.

The online manual for MPI on the web can be found at:\\
{\tt http:://www.mcs.anl.gov/mpi/index.html}
