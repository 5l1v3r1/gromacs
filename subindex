#!/usr/bin/awk -f

#
# (c) K. Anton Feenstra 2001
#
# subindex v. 0.1 - 12 feb 2001
#
# reads tex index entries as generated by makeindex and 
# combines identical words into sub-entries
#

BEGIN {
  h1=0;
  h2=0;
}

/, \\see/ {
  sub(", \\\\see.*","");
}

!/\\item/ {
  if (substr($0,1,1)!="%" && index($NF,"Symbol")==1)
    $0 = "% "$0;
  if ( pp ) {
    if ( index($0,"\item ")==0 || 
	 index($0,"\subitem ")==0 || 
	 index($0,"\subsubitem ")==0 )
      $0 = pp"\n"$0;
    else
      $0 = pp$0;
    pp=0;
  } else {
    if ( index(p,"\\see") ) sub(", *$","",p);
    if(NR>1 && p!=-1) print p;
    if ( (index(p,"\\see")==0 || index($0,"\\see")==0) && p!=-1 || $0=="")
      p=$0;
    else
      p=-1;
  }
}

/\\item/ {
  if ( $NF == "\\hfill" ) {
    pp=$0;
  } else {
    c1=$2;
    c2=$3;
    c3=$4;
    sub(",$","",c1);
    sub(",$","",c2);
    if(c1==p1) {
      if(c2==p2) {
	sub("item "c1" "c2",*","subitem");
	if (p3!="\\hfill" && !h2) {
	  printf("  \\item %s %s \\hfill\n",c1,c2);
	  sub("item "c1" "c2",*","subitem",p);
	}
	h2=1;
      } else {
	sub("item "c1",*","subitem");
	if (p2!="\\hfill" && !h1) {
	  printf("  \\item %s \\hfill\n",c1);
	  sub("item "c1",*","subitem",p);
	}
	h1=1;
	h2=0;
      }
    } else {
      h1=0;
    }
    if (p!=-1) print p;
    p=$0;
    p1=c1;
    p2=c2;
    p3=c3;
  }
}

END {
  print p;
}

#last line
