\newcommand{\dr}{{\rm d}r}
\newcommand{\avcsix}{\left< C_6 \right>}
\chapter{Long range corrections}
\label{ch:lrcorr}
\section{Dispersion}
In this section we derive long range corrections due to the use of
a cut-off for Lennard Jones interactions. 
We assume that the cut-off is so long that the repulsion term
can safely be neglected, and therefore only the dispersion term is
taken into account. Due to the nature of the dispersion interaction,
energy and pressure corrections both are negative. While
the energy correction is usually small, it may be important for
free energy calculations. The pressure correction in contrast is 
very large and can not be neglected. Although it is in principle
possible to parametrize a force field such that the pressure is
close to 1 bar even without correction, such a method makes the
parametrization dependent on the cut-off and is therefore
undesirable. Please note that it is not consistent to use the long range
correction to the dispersion without using either a reaction field
method or a proper long range electrostatics method such as Ewald
summation or PPPM.

\subsection{Energy}
\label{sec:ecorr}
The long range contribution of the dispersion interaction to the
virial can be derived analytically, if we assume a homogeneous
system beyond the cut-off distance $r_c$. The dispersion energy
between two particles is written as:
\beq
V(\rij)	~=~	- C_6 \rij^{-6}
\eeq
and the corresponding force is
\beq
\Fvij	~=~	- 6 C_6 \rij^{-8}\rvij
\eeq
The long range contribution to the dispersion energy
in a system with $N$ particles and particle density
$\rho$ = $N/V$, where $V$ is the volume, is~\cite{Allen87}:
\beq
V_{lr}  ~=~ \half N \rho\int_{r_c}^{\infty}   4\pi r^2 g(r) V(r) {\dr}
\eeq
which we can integrate assuming that the radial distribution function $g(r)$ 
is 1 beyond the cut-off $r_c$
\beq
V_{lr}	~=~ -\frac{2}{3} N \rho\pi C_6 r_c^{-3}
\eeq
If we consider for example a box of pure water, simulated with a cut-off
of 0.9 nm and a density of 1 g cm$^{-3}$ this correction is 
-0.25 kJ mol$^{-1}$.

For a homogeneous mixture of $M$ components $j$ with $N_j$ particles
each, we can write the long range contribution to the energy as:
\beq
V_{lr}	~=~ \sum_{i\ne j}^M -\frac{2 N_i N_j}{3 V}\pi C_6(ij) r_c^{-3}
\eeq
This can be rewritten if we define an {\em average dispersion constant}
$\avcsix$:
\bea
\label{eqn:avcsix}
\avcsix	&=&	\sum_{i\ne j}\frac{N_i N_j}{N^2} C_6(ij)\\
V_{lr}	&=&	-\frac{2}{3}N\rho\pi \avcsix r_c^{-3}
\eea
A special form of a non-homogeneous system in this respect,
is a pure liquid in which the atoms have different $C_6$ values.
In practice this definition encompasses almost every molecule,
except monatomic molecules and symmetric molecules like $N_2$ or $O_2$.
Therefore we always have to determine the average dispersion constant
$\avcsix$ in simulations.

In the case of inhomogenous simulation systems, e.g. a system with a
lipid interface, the energy correction can be applied if 
$\avcsix$ for both components is comparable.

\subsection{Virial and pressure}
The scalar virial of the system due to the disperion interaction between
two particles $i$ and $j$ is given by:
\beq
\Xi	~=~	-\rvij \cdot \Fvij ~=~	6 C_6 \rij^{-6}
\eeq
The pressure is given by:
\beq
P	~=~	\frac{2}{3\,V}\left(E_{kin} - \Xi\right)
\eeq
We can again integrate the long range contribution to the 
virial~\cite{Allen87}:
\bea
\Xi_{lr}&=&	\half N \rho \int_{r_c}^{\infty} 4\pi r^2 \, \Xi \dr	\nonumber\\
	&=&	12 N \pi \rho C_6  \int_{r_c}^{\infty} \rij^{-4}\dr \nonumber\\
	&=&	4 \pi C_6 N \rho r_c^{-3}
\eea
The corresponding correction to the pressure is
\beq
P_{lr}	~=~	-\frac{4}{3} \pi C_6 \rho^2 r_c^{-3}
\eeq
Using the same example of a water box, the correction to the virial is
3 kJ mol$^{-1}$ the corresponding correction to the pressure for 
SPC water at liquid density is approx. -280 bar.

For homogeneous mixtures we can again use the average dispersion constant
$\avcsix$ (\eqnref{avcsix}):
\beq
P_{lr}	~=~	-\frac{4}{3} \pi \avcsix \rho^2 r_c^{-3}
\label{eqn:pcorr}
\eeq
For inhomogeneous systems \eqnref{pcorr} can be applied under the same
restriction as holds for the energy (see \secref{ecorr}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%	AVERAGES AND FLUCTUATIONS
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Averages and fluctuations}
\section{Formulae for averaging}
{\bf Note:} this section was taken from ref~\cite{Gunsteren94a}.

When analysing a MD trajectory averages $\left<x\right>$ and fluctuations
\beq
 \left<(\Delta x)^2\right>^{\half} ~=~ \left<[x-\left<x\right>]^2\right>^{\half}
\label{eqn:var0}
\eeq
of a quantity $x$ are to be computed.
The variance $\sigma_x$ of a series of N$_x$ values, 
\{x$_i$\}, can be computed from
\beq
\sigma_x~=~ \sum_{i=1}^{N_x} x_i^2 ~-~  \frac{1}{N_x}\left(\sum_{i=1}^{N_x}x_i\right)^2
\label{eqn:var1}
\eeq
Unfortunately this formula is numerically not very accurate, 
especially when $\sigma_x^{\half}$ is small compared to the values of $x_i$. 
The following (equivalent) expression is numerically more accurate
\beq
\sigma_x ~=~ \sum_{i=1}^{N_x} [x_i  - \left<x\right>]^2
\eeq
with
\beq
  \left<x\right> ~=~ \frac{1}{N_x} \sum_{i=1}^{N_x} x_i
\label{eqn:var2}
\eeq
Using formulae ~(\eqnref{var1}) and ~(\eqnref{var2}) one has to go twice 
through the series of $x_i$ values, once to determine $\left<x\right>$ and again to 
compute $\sigma_x$, 
whereas formula~(\eqnref{var0}) requires only one sequential scan of
the series \{x$_i$\}. However, one may cast formula~(\eqnref{var1}) in
another form, containing partial sums, which allows for a sequential 
update algorithm. Define the partial sum
\beq
          X_{n,m} ~=~ \sum_{i=n}^{m} x_i                      
\eeq
and the partial variance
\beq
    \sigma_{n,m} ~=~ \sum_{i=n}^{m}  \left[x_i - \frac{X_{n,m}}{m-n+1}\right]^2  
\eeq
It can be shown that
\beq
          X_{n,m+k} ~=~  X_{n,m} + X_{m+1,m+k}         
\eeq
and
\bea
\sigma_{n,m+k} &=& \sigma_{n,m} + \sigma_{m+1,m+k} + \left[~\frac {X_{n,m}}{m-n+1} - \frac{X_{n,m+k}}{m+k-n+1}~\right]^2~* \nonumber\\
   && ~\frac{(m-n+1)(m+k-n+1)}{k}
\label{eqn:varpartial}
\eea
For $n=1$ one finds
\beq
\sigma_{1,m+k} ~=~ \sigma_{1,m} + \sigma_{m+1,m+k}~+~
  \left[~\frac{X_{1,m}}{m} - \frac{X_{1,m+k}}{m+k}~\right]^2~ \frac{m(m+k)}{k}
\label{eqn:sig1}
\eeq
and for $n=1$ and $k=1$ ~(\eqnref{varpartial}) becomes
\bea
\sigma_{1,m+1}  &=& \sigma_{1,m} + 
			\left[\frac{X_{1,m}}{m} - \frac{X_{1,m+1}}{m+1}\right]^2 m(m+1) \\
          	&=& \sigma_{1,m} + 
			\frac {[~X_{1,m} - m x_{m+1}~]^2}{m(m+1)}
\label{eqn:simplevar0}
\eea
where we have used the relation
\beq
     X_{1,m+1} ~=~  X_{1,m} + x_{m+1}                       
\label{eqn:simplevar1}
\eeq
Using formulae~(\eqnref{simplevar0}) and ~(\eqnref{simplevar1}) the average 
\beq
\left<x\right> ~=~ \frac{X_{1,N_x}}{N_x}
\eeq
and the fluctuation 
\beq
\left<(\Delta x)^2\right>^{\half} = \left[\frac {\sigma_{1,N_x}}{N_x}\right]^{\half}
\eeq
can be obtained by one sweep through the data. 

\section{Implementation}
In {\gromacs} the instantaneous
energies $E(m)$ are stored in the \normindex{energy file}, along with the 
values of $\sigma_{1,m}$ and $X_{1,m}$.
It is not uncommon to perform a simulation where the first part,
e.g. 100 ps, is taken as \normindex{equilibratium}. However, the
averages and fluctuations as printed in the \normindex{log file}
are computed over the whole simulation. The equilibration time,
which is now part of the simulation, may in such a case invalidate the
averages and fluctuations, because these numbers are now dominated
by the initial drift towards equilibrium.

Using the above equations the average and 
standard deviation over part of the trajectory can be computed as:
\bea
X_{m+1,m+k}	&=& X_{1,m+k} - X_{1,m}			\\
\sigma_{m+1,m+k} &=& \sigma_{1,m+k}-\sigma_{1,m} - \left[~\frac{X_{1,m}}{m} - \frac{X_{1,m+k}}{m+k}~\right]^{2}~ \frac{m(m+k)}{k}
\eea

or, more generally:
\bea
X_{p,q}		&=&	X_{1,q} - X_{1,p-1}	\\
\sigma_{p,q}	&=&	\sigma_{1,q}-\sigma_{1,p-1} - \left[~\frac{X_{1,p-1}}{p-1} - \frac{X_{1,q}}{q}~\right]^{2}~ \frac{(p-1)q}{q-p+1}
\eea
Of which the latter may be rewritten as
\beq
\sigma_{p,q}	~=~	\sigma_{1,q}-\sigma_{1,p-1} - \frac{\left[qX_{1,p-1} - (p-1)X_{1,q}~\right]^{2}}{(p-1)q(q-p+1)}
\eeq
