%
% $Id$
% 
%       This source code is part of
% 
%        G   R   O   M   A   C   S
% 
% GROningen MAchine for Chemical Simulations
% 
%               VERSION 2.0
% 
% Copyright (c) 1991-1999
% BIOSON Research Institute, Dept. of Biophysical Chemistry
% University of Groningen, The Netherlands
% 
% Please refer to:
% GROMACS: A message-passing parallel molecular dynamics implementation
% H.J.C. Berendsen, D. van der Spoel and R. van Drunen
% Comp. Phys. Comm. 91, 43-56 (1995)
% 
% Also check out our WWW page:
% http://md.chem.rug.nl/~gmx
% or e-mail to:
% gromacs@chem.rug.nl
% 
% And Hey:
% Gnomes, ROck Monsters And Chili Sauce
%

\chapter{Some implementation details.}
In this chapter we will present some implementation details. This is
far from complete, but we deemed it necessary to clarify some things
that would otherwise be hard to understand.
\input{virial}

\section{Optimizations}
Here we describe some of the algorithmic optimizations used 
in {\gromacs}, apart from parallelism. 
One of these, the implementation of the 
1.0/sqrt(x) function is treated separately in \secref{sqrt}.
The most important other optimizations are described below.

\subsection{Inner Loops for Water}
{\gromacs} users special inner loop to calculate non-bonded
interactions for water molecules with other atoms, and yet
another set of loops for interactions between pairs of
water molecules. This very optimized loop assumes 
a water model similar to
SPC~\cite{Berendsen81}, {\ie}:
\begin{enumerate}
\item   There are three atoms in the molecule.
\item   The first atom has Lennard-Jones (\secref{lj}) and 
        coulomb (\secref{coul}) interactions.
\item   Atoms two and three have only coulomb interactions, 
        and equal charges.
\end{enumerate}

The loop also works for the SPC/E~\cite{Berendsen87} and 
TIP3P~\cite{Jorgensen83} water models. For more complicated molecules
there is a general solvent loop assuming
(note the order):
\begin{enumerate}
\item   At the beginning of the molecule topology there is
        an arbitrary number of atoms with Lennard-Jones and
        coulomb interactions.
\item   Then we have an arbitrary number of atoms with coulomb interactions only.
\item   And finally there can be an arbitrary number of 
        atoms with Lennard-Jones interactions only.
\end{enumerate}
Note that this loop provides much less optimization than the water
loop, but it is slightly better than the default routine.

The gain of these implementations is that there are more floating point
operations in a single loop, which implies that some compilers
can schedule the code better. However, it turns out that even
some of the most advanced compilers have problems with scheduling, 
implying that manual tweaking is necessary to get optimum 
\normindex{performance}.
This may include common-subexpression elimination, or moving
code around. 

\subsection{Fortran Code}
Unfortunately, \normindex{Fortran} compilers are still better than
C-compilers, for most machines anyway. For some machines ({\eg} SGI
Power Challenge) the difference may be up to a factor of 3, in the
case of vector computers this may be even larger. Therefore, some of
the routines that take up a lot of computer time have been translated
into Fortran and even assembly code for Intel and AMD x86 processors.
In most cases, the Fortran or assembly loops should be selected 
automatically by the configure script when appropriate, but you can
also tweak this by setting options to the configure script.

\input{sqrt}

\input{tables}
