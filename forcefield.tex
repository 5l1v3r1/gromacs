%
% $Id$
% 
%       This source code is part of
% 
%        G   R   O   M   A   C   S
% 
% GROningen MAchine for Chemical Simulations
% 
%               VERSION 2.0
% 
% Copyright (c) 1991-1999
% BIOSON Research Institute, Dept. of Biophysical Chemistry
% University of Groningen, The Netherlands
% 
% Please refer to:
% GROMACS: A message-passing parallel molecular dynamics implementation
% H.J.C. Berendsen, D. van der Spoel and R. van Drunen
% Comp. Phys. Comm. 91, 43-56 (1995)
% 
% Also check out our WWW page:
% http://md.chem.rug.nl/~gmx
% or e-mail to:
% gromacs@chem.rug.nl
% 
% And Hey:
% Gnomes, ROck Monsters And Chili Sauce
%

\chapter{Force fields}
\label{ch:ff}
A \normindex{force field} is built up from two distinct components:
\begin{itemize}
\item The set of equations (called the {\em \normindex{potential
function}s}) used to generate the potential energies and their
derivatives, the forces.
\item The parameters used in this set of equations
\end{itemize}
Within one set of equations various sets of parameters can be
used. Care must be taken that the combination of equations and
parameters form a consistent set. It is in general dangerous to make
{\em ad hoc} changes in a subset of parameters, because the various
contributions to the total force are usually interdependent.

In {\gromacs} {\gmxver} the force field is based on
\gromosv{87}~\cite{biomos}\index{gromos-87},
with a small modification concerning the interaction between
water-oxygens and carbon atoms~\cite{Buuren93b,Mark94}, as well as 10
extra atom types~\cite{Jorgensen83,Buuren93a,Buuren93b,Mark94,Liu95}.
However, the user is free to make her own modifications (beware!).
This will be explained in details in \chref{top}, which deals
with the {\bf Topology}.\\ To accommodate the potential functions used
in some popular force fields, {\gromacs} offers a choice of functions,
both for non-bonded interaction and for dihedral interactions. They
are described in the appropriate subsections.

The potential functions can be subdivided into three parts
\begin{enumerate}
\item   {\em Non-bonded}: Lennard-Jones or Buckingham, and Coulomb or
modified Coulomb. The non-bonded interactions are computed on the
basis of a neighbor list (a list of non-bonded atoms within a certain
radius), in which exclusions are already removed.
\item   {\em Bonded}: covalent bond-stretching, angle-bending,
improper dihedrals, and proper dihedrals. These are computed on the
basis of fixed lists. 
\item   {\em Special}: position restraints and distance restraints,
based on fixed lists. 
\end{enumerate}

\section{Non-bonded interactions}
Non-bonded interactions in {\gromacs} are pair-additive and centro-symmetric:
\beq
V(\ve{r}_1,\ldots \ve{r}_N) = \sum_{i<j}V_{ij}(\rvij);
\eeq
\beq
\ve{F}_i = -\sum_j \frac{dV_{ij}(r_{ij})}{dr_{ij}} \frac{\rvij}{r_{ij}} = -\ve{F}_j
\eeq
The non-bonded interactions contain a \normindex{repulsion} term, 
a \normindex{dispersion}
term, and a Coulomb term. The repulsion and dispersion term are
combined in either the Lennard-Jones (or 6-12 interaction), or the
Buckingham (or exp-6 potential). In addition, (partially) charged atoms
act through the Coulomb term. 

\subsection{The Lennard-Jones interaction}
\label{sec:lj}
The \normindex{Lennard Jones} potential $V_{LJ}$ between two atoms equals
\beq
V_{LJ}(\rij) =  \frac{C_{ij}^{(12)}}{\rij^{12}} -
                        \frac{C_{ij}^{(6)}}{\rij^6}     
\eeq
see also \figref{lj}
The parameters $C^{(12)}_{ij}$ and $C^{(6)}_{ij}$  depend on pairs of
{\em atom types}; consequently they are taken from a matrix of
LJ-parameters.

\begin{figure}
\centerline{\psfig {figure=plots/f_lj.eps,angle=270,width=8cm}}
\caption {The Lennard-Jones interaction.}
\label{fig:lj}
\end{figure}
 
The force derived from this potential is:
\beq
\ve{F}_i(\rvij) = \left( 12~\frac{C_{ij}^{(12)}}{\rij^{12}} -
                                 6~\frac{C_{ij}^{(6)}}{\rij^6} \right) \rnorm 
\eeq

The LJ potential may also be written in the following form :
\beq
V_{LJ}(\rvij) = 4\epsilon_{ij}\left(\left(\frac{\sigma_{ij}} {\rij}\right)^{12}
                - \left(\frac{\sigma_{ij}}{\rij}\right)^{6} \right)
\label{eqn:sigeps}      
\eeq

In constructing the parameter matrix for the non-bonded LJ-parameters,
two types of combination rules can be used within {\gromacs}: 
\beq
\begin{array}{rcl}
C_{ij}^{(6)}    &=& \left({C_{ii}^{(6)} * C_{jj}^{(6)}}\right)^{1/2}    \\
C_{ij}^{(12)}   &=& \left({C_{ii}^{(12)} * C_{jj}^{(12)}}\right)^{1/2}
\label{eqn:comb}
\end{array}
\eeq
or, alternatively,
\beq
\begin{array}{rcl}
 \sigma_{ij}   &=& \frac{1}{ 2}(\sigma_{ii}+\sigma_{jj})        \\
 \epsilon_{ij} &=& \left({\epsilon_{ii} \epsilon_{jj}}\right)^{1/2}
\end{array}
\eeq

\subsection{Buckingham potential}
The \normindex{Buckingham} 
potential has a more flexible and realistic repulsion term
than the Lennard Jones interaction, but is also more expensive to
compute. The potential form is:
\beq
V_{bh}(\rij) = A_{ij} \exp(-B_{ij} \rij) -
                        \frac{C_{ij}}{\rij^6}
\eeq
\begin{figure}
\centerline{\psfig {figure=plots/f_bham.eps,angle=270,width=8cm}}
\caption {The Buckingham interaction.}
\label{fig:bham}
\end{figure}

see also \figref{bham}, the force derived from this is:
\beq
 \ve{F}_i(\rij) = \left[ -A_{ij}B_{ij}\rij \exp(-B_{ij} \rij) -
                                 6\frac{C_{ij}}{\rij^6} \right] \rnorm
\eeq

\subsection{Coulomb interaction}
\label{sec:coul}
\newcommand{\epsr}{\varepsilon_r}
\newcommand{\epsrf}{\varepsilon_{rf}}
The \normindex{Coulomb} interaction between two charge particles is given by:
\beq
V_c(\rij) = f \frac{q_i q_j}{\epsr \rij}
\label{eqn:vcoul}
\eeq
see also \figref{coul}, where $f = \frac{1}{4\pi \varepsilon_0} =
138.935\,485$ (see \chref{defunits})

\begin{figure}
\centerline{\psfig {figure=plots/vcrf.eps,width=8cm}}
\caption[The Coulomb interaction with and without reaction field.]{The
Coulomb interaction (for particles with equal signed charge) with and
without reaction field. In the latter case $\epsrf$ was 78, and $r_c$
was 0.9 nm. The dot-dashed line is the same as the dashed line, except
for a constant.}
\label{fig:coul}
\end{figure}

The force derived from this potential is:
\beq
\ve{F}_i(\rvij) = f \frac{q_i q_j}{\epsr\rij^2}\rnorm
\eeq

In {\gromacs} the  relative \normindex{dielectric constant} 
\normindex{$\epsr$}
may be set in the in the input for {\tt grompp}. 

\subsection{Coulomb interaction with \normindex{reaction field}}
\label{sec:coulrf}
The coulomb interaction can be modified for homogeneous systems, by
assuming a constant dielectric environment beyond the cut-off $r_c$
with a dielectric constant of {$\epsrf$}. The interaction then reads:
\beq
V_{crf} ~=~     f \frac{q_i q_j}{\rij}\left[1+\frac{\epsrf-1}{2\epsrf+1}\frac{\rij^3}{r_c^3}\right] - f\frac{q_i q_j}{r_c}\frac{3\epsrf}{2\epsrf+1}
\label{eqn:vcrf}
\eeq
in which the constant expression on the right makes the potential
zero at the cut-off $r_c$. We can rewrite this for simplicity as
\beq
V_{crf} ~=~     f q_i q_j\left[\frac{1}{\rij} + k_{rf}~ \rij^2 -c_{rf}\right]
\eeq
with
\bea
k_{rf}  &=&     \frac{1}{r_c^3}\,\frac{\epsrf-1}{(2\epsrf+1)}   \label{eqn:krf}\\
c_{rf}  &=&     \frac{1}{r_c}+k_{rf}\,r_c^2 ~=~ \frac{1}{r_c}\,\frac{3\epsrf}{(2\epsrf+1)}
\label{eqn:crf}
\eea
for large $\epsrf$ the $k_{rf}$ goes to 0.5~$r_c^{-3}$,
while for $\epsrf$ = 1 the correction vanishes.
This makes it possible to use
the same expression with and without reaction field, albeit at some
computational cost. 
In \figref{coul}
the modified interaction is plotted, and it is clear that the derivative 
with respect to $\rij$ (= -force) goes to zero at the cut-off distance.
The force derived from this potential reads:
\beq
\ve{F}_i(\rvij) = f q_i q_j\left[\frac{1}{\rij^2} - 2 k_{rf}\rij\right]\rnorm
\eeq
Tironi {\etal} have introduced a generalized reaction field in which
the dielectric continuum beyond the cut-off $r_c$ also has an ionic strength
$I$~\cite{Tironi95}. In this case we can rewrite the constants $k_{rf}$ and 
$c_{rf}$ using the inverse Debye screening length $\kappa$:
\bea
\kappa  &=&     \frac{2 I \,F^2}{\varepsilon_0 \epsrf RT}=\frac{F^2}{\varepsilon_0 \epsrf RT}\sum_{i=1}^{K} c_i z_i     \\
k_{rf}  &=&     \frac{1}{r_c^3}\,\frac{(\epsrf-1)(1+\kappa r_c) + \epsrf(\kappa r_c)^2}{(2\epsrf+1)(1+\kappa r_c) + \epsrf(\kappa r_c)^2}       \label{eqn:kgrf}\\
c_{rf}  &=&     \frac{1}{r_c}\,\frac{3\epsrf(1+\kappa r_c)+2\epsrf(\kappa r_c)^2}{(2\epsrf+1)(1+\kappa r_c) + \epsrf(\kappa r_c)^2}
\label{eqn:cgrf}
\eea
where $F$ is Faraday's constant, $R$ is the ideal gas constant, $T$
the absolute temperature, $c_i$ the molar concentration for species
$i$ and $z_i$ the charge number of species $i$ where we have $K$
different species. In the limit of zero ionic strength ($\kappa$ = 0)
\eqnsref{kgrf}{cgrf} reduce to the simple forms of \eqnsref{krf}{crf}
respectively.

\subsection{Modified non-bonded interactions}
In the {\gromacs} force field the non-bonded potentials can be
modified by a shift function. The purpose of this is to replace the
truncated forces by forces that are continuous and have continuous
derivatives at the \normindex{cut-off} radius. With such forces the
time-step integration produces much smaller errors and there are no
such complications as creating charges from dipoles by the truncation
procedure. In fact, by using shifted forces there is no need for
charge groups in the construction of neighbor lists. However, the
shift function produces a considerable modification of the Coulomb
potential. Unless the 'missing' long-range potential is properly
calculated and added (through the use of PPPM, Ewald, or PME), the
effect of such modifications must be carefully evaluated.  The
modification of the Lennard-Jones dispersion and repulsion is only
minor, but it does remove the noise caused by cut-off effects.
 
There is {\em no} fundamental difference between a switch function
(which multiplies the potential with a function) and a shift function
(which adds a function to the force or potential). The switch
function is a special case of the shift function, which we apply to
the {\em force function} $F(r)$, related to the electrostatic or
Van der Waals force acting on particle $i$ by particle $j$ as
\beq
\ve{F}_i = c F(r_{ij}) \frac{\rvij}{r_{ij}}
\eeq
For pure Coulomb or Lennard-Jones interactions
$F(r)=F_\alpha(r)=r^{-(\alpha+1)}$.
The shifted force $F_s(r)$ can generally be written as:
\beq
\begin{array}{rcl}
\vspace{2mm}
F_s(r)~=&~F_\alpha(r)   & r < r_1               \\
\vspace{2mm}
F_s(r)~=&~F_\alpha(r)+S(r)      & r_1 \le r < r_c       \\
F_s(r)~=&~0             & r_c \le r     
\end{array}
\eeq
When $r_1=0$ this is a traditional shift function, otherwise it acts as a 
switch function. The corresponding shifted coulomb potential then reads:
\beq
V_s(r_{ij}) = f \Phi_s (r_{ij}) q_i q_j
\eeq
where $\Phi(r)$ is the potential function 
\beq
\Phi_s(r) =  \int^{\infty}_r~F_s(x)\, dx
\eeq

The {\gromacs} shift function should be smooth at the boundaries, therefore
the following boundary conditions are imposed on the shift function:
\beq
\begin{array}{rcl}
S(r_1)          &=&0            \\
S'(r_1)         &=&0            \\
S(r_c)          &=&-F_\alpha(r_c)       \\
S'(r_c)         &=&-F_\alpha'(r_c)
\end{array}
\eeq
A 3$^{rd}$ degree polynomial of the form
\beq
S(r) = A(r-r_1)^2 + B(r-r_1)^3
\eeq
fulfills these requirements. The constants A and B are given by the
boundary condition at $r_c$: 
\beq
\begin{array}{rcl}
\vspace{2mm}
A &~=~& -\displaystyle
        \frac{(\alpha+4)r_c~-~(\alpha+1)r_1} {r_c^{\alpha+2}~(r_c-r_1)^2} \\
B &~=~& \displaystyle
        \frac{(\alpha+3)r_c~-~(\alpha+1)r_1}{r_c^{\alpha+2}~(r_c-r_1)^3}
\end{array}
\eeq
Thus the total force function is
\beq
F_s(r) = \frac{1}{r^{\alpha+1}} + A(r-r_1)^2 + B(r-r_1)^3
\eeq
and the potential function reads
\beq
\Phi(r) = \frac{1}{r^\alpha} - \frac{A}{3} (r-r_1)^3 - \frac{B}{4} (r-r_1)^4 - C
\eeq
where 
\beq
C =  \frac{1}{r_c^\alpha} - \frac{A}{3} (r_c-r_1)^3 - \frac{B}{4} (r_c-r_1)^4
\eeq

When $r_1$ = 0, the modified Coulomb force function is
\beq
 F_s(r) = \frac{1}{r^2} - \frac{5 r^2}{r_c^4} + \frac{4 r^3}{r_c^5}
\eeq
identical to the {\em \normindex{parabolic force}} 
function recommended to be used as a short-range function in 
conjunction with a \normindex{Poisson solver} 
for the long-range part~\cite{Berendsen93a}.
The modified Coulomb potential function is
\beq
\Phi(r) = \frac{1}{r} - \frac{5}{3r_c} + \frac{5r^3}{3r_c^4} - \frac{r^4}{r_c^5}
\eeq
see also \figref{shift}.

\begin{figure}
\centerline{\psfig {figure=plots/shiftf.eps,angle=270,width=10cm}}
\caption[The Coulomb Force, Shifted Force and Shift Function
$S(r)$,.]{The Coulomb Force, Shifted Force and Shift Function $S(r)$,
using r$_1$ = 2 and r$_c$ = 4.} 
\label{fig:shift}
\end{figure}

\subsection{Modified short-range interactions with Ewald summation}
When \normindex{Ewald sum}mation or \seeindex{particle-mesh
Ewald}{PME} is used to calculate the long-range interactions, the
short-range coulomb potential must also be modified, similar to the
switch function above. In this case the short range potential is given
by
\beq
V(r) = f \frac{\mbox{erfc}(\beta r_{ij})}{r_{ij}} q_i q_j,
\eeq
where $\beta$ is a parameter that determines the relative weight 
between the direct space sum and the reciprocal space sum and erfc$(x)$ is
the complementary error function. For further 
details on long-range electrostatics, see \secref{lr_elstat}.


\section{Bonded interactions}
Bonded interactions are based on a fixed list of atoms. They are not
exclusively pair interactions, but include 3- and 4-body interactions
as well. There are {\em bond stretching} (2-body), {\em bond angle}
(3-body), and {\em dihedral angle} (4-body) interactions. A special
type of dihedral interaction (called {\em improper dihedral}) is used
to force atoms to remain in a plane or to prevent transition to a
configuration of opposite chirality (a mirror image).

\subsection{Bond stretching}
\label{sec:bondpot}
\subsubsection{Harmonic potential}
The \normindex{bond stretching} between two covalently bonded atoms
$i$ and $j$ is represented by a harmonic potential

\begin{figure}
\centerline{\raisebox{-1.8cm}{\psfig{figure=plots/bstretch.eps,angle=270,width=5cm}}\psfig{figure=plots/f_bond.eps,angle=270,width=7cm}}
\caption[Bond stretching.]{Principle of bond stretching (left), and the bond
stretching potential (right).}
\label{fig:bstretch1}
\end{figure}

\beq
V_b~(\rij) = \half k^b_{ij}(\rij-b_{ij})^2
\eeq
see also \figref{bstretch1}, with the force
\beq
\ve{F}_i(\rvij) = k^b_{ij}(\rij-b_{ij}) \rnorm
\eeq

\subsubsection{Fourth power potential}
In the \gromosv{96} force field~\cite{gromos96} the covalent bond potential
is written for reasons of computational efficiency as:
\beq
V_b~(\rij) = \frac{1}{4}k^b_{ij}\left(\rij^2-b_{ij}^2\right)^2
\eeq
the corresponding  force is:
\beq
\ve{F}_i(\rvij) = k^b_{ij}(\rij^2-b_{ij}^2)~\rvij
\eeq
The force constants for this form of the potential is related to the usual
harmonic force constant $k^{b,harm}$ (\secref{bondpot}) as
\beq
2 k^b b_{ij}^2 = k^{b,harm}
\eeq
The force constants are mostly derived from the harmonic ones used in 
\gromosv{87}~\cite{biomos}. Although this form is computationally more efficient
(because no square root has to be evaluated), it is conceptually more
complex. One particular disadvantage is that since the form is not harmonic,
the average energy of a single bond is not equal to $\half kT$ as it is for 
the normal harmonic potential.

\subsection{Morse potential bond stretching}
%\author{F.P.X. Everdij}
%
For some systems that require an anharmonic bond stretching potential,
the Morse potential~\cite{Morse29} 
between two atoms {\it i} and {\it j} is available
in {\gromacs}. This potential differs from the harmonic potential in
having an asymmetric potential well and a zero force at infinite
distance The functional form is:
\beq
\displaystyle V_{morse} (r_{ij}) = D_{ij} [1 - \exp(-\beta_{ij}(r_{ij}-b_{ij}))]^2,
\eeq
see also \figref{morse}, and the corresponding force is:
\beq
\begin{array}{rcl}
\displaystyle {\bf F}_{morse} ({\bf r}_{ij})&=&2 D_{ij} \beta_{ij} r_{ij} \exp(-\beta_{ij}(r_{ij}-b_{ij})) * \\
\displaystyle \: & \: &[1 - \exp(-\beta_{ij}(r_{ij}-b_{ij}))] \frac{\displaystyle {\bf r}_{ij}}{\displaystyle r_{ij}},
\end{array}
\eeq
where \( \displaystyle D_{ij} \) is the depth of the well in kJ/mol,
\( \displaystyle \beta_{ij} \) defines the steepness of the well (in
nm\(^{-1} \)), and \( \displaystyle b_{ij} \) is the equilibrium
distance in nm.  The steepness parameter \( \displaystyle \beta_{ij}
\) can be expressed in terms of the reduced mass of the atoms {\it i}
and {\it j}, the fundamental vibration frequency \( \displaystyle
\omega_{ij} \) and the well depth \( \displaystyle D_{ij} \):
\beq
\displaystyle \beta_{ij}= \omega_{ij} \sqrt{\frac{\mu_{ij}}{2 D_{ij}}}
\eeq
and because \( \displaystyle \omega = \sqrt{k/\mu} \), one can rewrite \( \displaystyle \beta_{ij} \) in terms of the harmonic force constant \( \displaystyle k_{ij} \)
\beq
\displaystyle \beta_{ij}= \sqrt{\frac{k_{ij}}{2 D_{ij}}}
\eeq
For small deviations \( \displaystyle (r_{ij}-b_{ij}) \), one can expand the \( \displaystyle \exp \)-term to first-order in the Taylor expansion: 
\beq
\displaystyle \exp(-x) \approx 1-x
\eeq
Substituting this in the functional from;
\beq
\begin{array}{rcl}
\displaystyle V_{morse} (r_{ij})&=&D_{ij} [1 - \exp(-\beta_{ij}(r_{ij}-b_{ij}))]^2\\
\displaystyle \:&=&D_{ij} [1 - (1 -\sqrt{\frac{k_{ij}}{2 D_{ij}}}(r_{ij}-b_{ij}))]^2\\
\displaystyle \:&=&\frac{1}{2} k_{ij} (r_{ij}-b_{ij}))^2,
\end{array}
\eeq
one recovers the harmonic bond stretching potential.

\begin{figure}
\centerline{\psfig {figure=plots/f_morse.eps,width=7cm}}
\caption{The Morse potential well, with bond length 0.15 nm.}
\label{fig:morse}
\end{figure}

\subsection{Bond angle vibration}
\label{sec:anglepot}
\subsubsection{Harmonic potential}
\newcommand{\tijk}{\theta_{ijk}}
The bond \normindex{angle vibration} between a triplet of atoms $i$ - $j$ - $k$
is also represented by a harmonic potential on the angle $\tijk$

\begin{figure}
\centerline{\raisebox{-1.5cm}{\psfig {figure=plots/angle.eps,angle=270,width=5cm}}\psfig {figure=plots/f_angle.eps,angle=270,width=7cm}}
\caption[Angle vibration.]{Principle of angle vibration (left) and the
bond angle potential (right).}
\label{fig:angle}
\end{figure}

\beq
V_a(\tijk) = \half k^{\theta}_{ijk}(\tijk-\tijk^0)^2
\eeq
As the bond-angle vibration is represented by a harmonic potential the
form is the same as the bond stretching (\figref{bstretch1}).

The force equations are given by the chain rule:
\beq
\begin{array}{l}
\Fvi    ~=~ -\displaystyle\frac{d V_a(\tijk)}{d \rvi}   \\
\Fvk    ~=~ -\displaystyle\frac{d V_a(\tijk)}{d \rvk}   \\
\Fvj    ~=~ -\Fvi-\Fvk
\end{array}
~ \mbox{ ~ where ~ } ~
 \tijk = \arccos \frac{(\rvij \cdot \ve{r}_{kj})}{r_{ij}r_{kj}}
\eeq
The numbering $i,j,k$ is in sequence of covalently bonded atoms, with $j$ denoting the middle atom (see \figref{angle}).

\subsubsection{Cosine based potential}
\label{sec:cosangle}
In the \gromosv{96} force field a simplified function is used to represent angle
vibrations:
\beq
V_a(\tijk) = \half k^{\theta}_{ijk}\left(\cos(\tijk) - \cos(\tijk^0)\right)^2
\eeq
where 
\beq
\cos(\tijk) = \frac{\rvij\cdot\ve{r}_{kj}}{\rij r_{kj}}
\eeq
The corresponding force can be derived by partial differentiation with respect
to the atomic positions. The force constants in this function are related
to the force constants in the harmonic form $k^{\theta,harm}$
(\secref{anglepot}) by:
\beq
k^{\theta} \sin^2(\tijk^0) = k^{\theta,harm}
\eeq

%% new commands %%%%%%%%%%%%%%%%%%%%%%
\newcommand{\rvkj}{{\bf r}_{kj}}
\newcommand{\rkj}{r_{kj}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Improper dihedrals}
Improper Dihedrals are meant to keep \normindex{planar groups} planar ({\eg} 
aromatic rings) or to prevent molecules from flipping over to their
\normindex{mirror image}s, see \figref{imp}.

\begin {figure}
\centerline{\psfig{figure=plots/ring-imp.eps,angle=270,width=4cm}\hspace{1cm}
\psfig{figure=plots/subst-im.eps,angle=270,width=3cm}\hspace{1cm}\psfig{figure=plots/tetra-im.eps,angle=270,width=3cm}}
\caption[Improper dihedral angles.]{Principle of improper
dihedral angles. Out of plane bending for rings (left), substituents
of rings (middle), out of tetrahedral (right). The improper dihedral
angle $\xi$ is defined as the angle between planes (i,j,k) and (j,k,l)
in all cases.}
\label{fig:imp}
\end {figure}

\beq
V_{id}(\xi_{ijkl}) = k_{\xi}(\xi_{ijkl}-\xi_0)^2
\eeq
This is also a harmonic potential, it is plotted in
\figref{imps}. Note that, since it is harmonic, periodicity is
not taken into account, so it is best to define improper dihedrals
to have a $\xi_0$ as far away from $\pm 180^\circ$ as you can manage.

\begin{figure}
\centerline{\psfig{figure=plots/f_imps.eps,angle=270,width=8cm}}
\caption{Improper dihedral potential.}
\label{fig:imps}
\end{figure}

\subsection{Proper dihedrals}
For the normal \normindex{dihedral} interaction there is a choice of either the
{\gromos} periodic function or a function based on expansion in powers of
$\cos \phi$ (the so-called Ryckaert-Bellemans potential). This choice
has consequences for the inclusion of special interactions between the
first and the fourth atom of the dihedral quadruple. With the periodic
{\gromos} potential a special 1-4 LJ-interaction must be included; with
the Ryckaert-Bellemans potential the \normindex{1-4 interactions} 
must be excluded from the non-bonded list.  

\subsubsection{Proper dihedrals: periodic type}
\normindex{Proper dihedral} angles are defined according to the IUPAC/IUB
convention, where $\phi$ is the angle between the $ijk$ and the $jkl$
planes, with {\bf zero} corresponding to the {\em cis} configuration
($i$ and $l$ on the same side).

\begin{figure}
\centerline{\raisebox{-1cm}{\psfig {figure=plots/dih.eps,angle=270,width=5cm}}\psfig {figure=plots/f_dih.eps,angle=270,width=7cm}}
\caption[Proper dihedral angle.]{Principle of proper dihedral angle
(left, in {\em trans} form) and the dihedral angle potential (right).} 
\label{fig:pdihf}
\end{figure}

\beq
V_d(\phi_{ijkl}) = k_{\phi}(1 + \cos(n \phi - \phi_0))
\eeq

\subsubsection{Proper dihedrals: Ryckaert-Bellemans function}
For alkanes, the following proper dihedral potential is often used
(see \figref{rbdih})
\beq
V_{rb}(\phi_{ijkl}) = \sum_{n=0}^5 C_n( \cos(\psi ))^n,
\eeq 
where $\psi = \phi - 180^\circ$.  \\
{\bf Note:} A conversion from one convention to another can be achieved by 
multiplying every coefficient \( \displaystyle C_n \) 
by \( \displaystyle (-1)^n \).

An example of constants for $C$ is given in \tabref{crb}.

\begin{table}
\centerline{
\begin{tabular}{|lr|lr|lr|}
\dline
$C_0$   & 9.28  & $C_2$   & -13.12  & $C_4$   & 26.24   \\
$C_1$   & 12.16 & $C_3$   & -3.06   & $C_5$   & -31.5   \\
\dline
\end{tabular}
}
\caption{Constants for Ryckaert-Bellemans potential (kJ mol$^{-1}$).}
\label{tab:crb}
\end{table}

\begin{figure}
\centerline{\psfig {figure=plots/f_rbs.eps,angle=270,width=8cm}}
\caption{Ryckaert-Bellemans dihedral potential.}
\label{fig:rbdih}
\end{figure}

({\bf Note:} The use of this potential implies exclusions of LJ-interactions
between the first and the last atom of the dihedral, and $\psi$ is defined
according to the 'polymer convention' ($\psi_{trans}=0$).)

The RB dihedral function can also be used to include the \normindex{OPLS} 
dihedral potential~\cite{Jorgensen88}. 
The OPLS potential function is given as the first 
four terms of a Fourier series:
\beq
V_{rb} (\phi_{ijkl}) ~=~ V_0 + \frac{1}{2} (V_1(1+\cos(\psi)) + V_2(
1-\cos(2\psi)) + V_3(1+\cos(3\psi))),
\eeq
with \( \displaystyle \psi=\phi \) (protein convention).
Because of the equalities \( \cos(2\phi) = 2(\cos(\phi))^2 - 1 \) 
and \( \cos(3\phi) = 4(\cos(\phi))^3 - 3\cos(\phi) \), 
one can translate the OPLS parameters to 
Ryckaert-Bellemans parameters as follows:
\beq
\displaystyle
\begin{array}{rcl}
\displaystyle C_0&=&V_0 + V_2 + \frac{1}{2} (V_1 + V_3)\\
\displaystyle C_1&=&\frac{1}{2} (3V_3 - V_1)\\
\displaystyle C_2&=&-V_2\\
\displaystyle C_3&=&-2V_3\\
\displaystyle C_4&=&0\\
\displaystyle C_5&=&0
\end{array}
\eeq
with OPLS parameters in protein convention and RB parameters in 
polymer convention.\\
\noindent{\bf Note:} Mind the conversion from {\em kcal mol$^{-1}$} for 
OPLS and RB parameters in literature to {\em kJ mol$^{-1}$} in {\gromacs}.

\subsection{Special interactions}
Special potentials are used for imposing restraints on the motion of
the system, either to avoid disastrous deviations, or to include
knowledge from experimental data. In either case they are not really
part of the force field and the reliability of the parameters is not
important. The potential forms, as implemented in {\gromacs}, are
mentioned just for the sake of completeness.

\subsection{\normindex{Position restraints}}
\label{sec:posre}
These are used to restrain particles to fixed reference positions
$\ve{R}_i$. They can be used during equilibration in order to avoid
too drastic rearrangements of critical parts ({\eg} to restrain motion
in a protein that is subjected to large solvent forces when the
solvent is not yet equilibrated). Another application is the
restraining of particles in a shell around a region that is simulated
in detail, while the shell is only approximated because it lacks
proper interaction from missing particles outside the
shell. Restraining will then maintain the integrity of the inner
part. For spherical shells it is a wise procedure to make the force
constant depend on the radius, increasing from zero at the inner
boundary to a large value at the outer boundary. This application has
not been implemented in {\gromacs} however.
\newcommand{\unitv}[1]{\hat{\bf #1}}
\newcommand{\halfje}[1]{\frac{#1}{2}}

The following form is used: 
\beq
V_{pr}(\ve{r}_i) = \halfje{1}k_{pr}|\rvi-\ve{R}_i|^2
\eeq
The potential is plotted in \figref{posres}.

\begin{figure}
\centerline{\psfig {figure=plots/f_pr.eps,angle=270,width=8cm}}
\caption{Position restraint potential.}
\label{fig:posres}
\end{figure}

The potential form can be rewritten without loss of generality as:
\beq
V_{pr}(\ve{r}_i) = \halfje{1} \left[ k_{pr}^x (x_i-X_i)^2 ~\unitv{x} + k_{pr}^y (y_i-Y_i)^2 ~\unitv{y} + k_{pr}^z (z_i-Z_i)^2 ~\unitv{z}\right]
\eeq

Now the forces are:
\beq
\begin{array}{rcl}
F_i^x &=& -k_{pr}^x~(x_i - X_i) \\
F_i^y &=& -k_{pr}^y~(y_i - Y_i) \\
F_i^z &=& -k_{pr}^z~(z_i - Z_i)
\end{array}
\eeq
Using three different force constants the position 
restraints can be turned on or off
in each spatial dimension; this means that atoms can be harmonically
restrained to a plane or a line.
Position restraints are applied to a special fixed list of atoms. Such a
list is usually generated by the \normindex{pdb2gmx} program.

\subsection{\normindex{Angle restraints}}
\label{sec:angres}
These are used to restrain the angle between two pairs of particles
or between one pair of particles and the Z-axis.
The functional form is similar to that of a proper dihedral.
For two pairs of atoms: 
\beq
V_{ar}(\ve{r}_i,\ve{r}_j,\ve{r}_k,\ve{r}_l)
        = k_{ar}(1 - \cos(n (\theta - \theta_0))
        )
,~~~~\mbox{where}~~
\theta = \arccos\left(\frac{\ve{r}_j -\ve{r}_i}{\|\ve{r}_j -\ve{r}_i\|}
 \cdot \frac{\ve{r}_l -\ve{r}_k}{\|\ve{r}_l -\ve{r}_k\|} \right)
\eeq
For one pair of atoms and the Z-axis: 
\beq
V_{ar}(\ve{r}_i,\ve{r}_j) = k_{ar}(1 - \cos(n (\theta - \theta_0))
        )
,~~~~\mbox{where}~~
\theta = \arccos\left(\frac{\ve{r}_j -\ve{r}_i}{\|\ve{r}_j -\ve{r}_i\|}
 \cdot \left( \begin{array}{c} 0 \\ 0 \\ 1 \\ \end{array} \right) \right)
\eeq
A multiplicity ($n$) of 2 is useful when you do not want to distinguish
between parallel and anti-parallel vectors.


\subsection{Distance restraints}
\label{sec:disre}
\normindex{Distance restraints} 
add a penalty to the potential when the distance between specified
pairs of atoms exceeds a threshold value. They are normally used to
impose experimental restraints, as from experiments in nuclear
magnetic resonance (NMR), on the motion of the system. Thus MD can be
used for structure refinement using NMR data\index{nmr
refinement}. The potential form is quadratic below a specified lower
bound and between two specified upper bounds and linear beyond the
largest bound (see \figref{dist}).
\beq
V_{dr}(r_{ij}) ~=~ \left\{
\begin{array}{lcllllll}
\half k_{dr}(r_{ij}-r_0)^2	
		&\mbox{for}&     &     & r_{ij} & < & r_0	\\[1.5ex]
0		&\mbox{for}& r_0 & \le & r_{ij} & < & r_1	\\[1.5ex]
\half k_{dr}(r_{ij}-r_1)^2	
		&\mbox{for}& r_1 & \le & r_{ij} & < & r_2	\\[1.5ex]
\half k_{dr}(r_2-r_1)(2r_{ij}-r_2-r_1)	
		&\mbox{for}& r_2 & \le & r_{ij} &   &
\end{array}\right.
\label{eqn:disre}
\eeq

\begin{figure}
\centerline{\psfig {figure=plots/f_dr.eps,width=8cm}}
\caption{Distance Restraint potential.}
\label{fig:dist}
\end{figure}

The forces are
\beq
\ve{F}_i~=~ \left\{
\begin{array}{lcllllll}
-k_{dr}(r_{ij}-r_0)\frac{\rvij}{r_{ij}}	
		&\mbox{for}&     &     & r_{ij} & < & r_0	\\[1.5ex]
0		&\mbox{for}& r_0 & \le & r_{ij} & < & r_1	\\[1.5ex]
-k_{dr}(r_{ij}-r_1)\frac{\rvij}{r_{ij}}	
		&\mbox{for}& r_1 & \le & r_{ij} & < & r_2	\\[1.5ex]
-k_{dr}(r_2-r_1)\frac{\rvij}{r_{ij}}	
		&\mbox{for}& r_2 & \le & r_{ij} &   &
\end{array} \right.
\eeq

\subsubsection{Time averaging}

Distance restraints based on instantaneous distances can greatly reduce
the fluctuations in a molecule. This problem can be overcome by restraining
to a {\em time averaged} distance~\cite{Torda89}.
The forces with time averaging are:
\beq
\ve{F}_i~=~ \left\{
\begin{array}{lcllllll}
-k_{dr}(\bar{r}_{ij}-r_0)\frac{\rvij}{r_{ij}}	
		&\mbox{for}&     &     & \bar{r}_{ij} & < & r_0	\\[1.5ex]
0		&\mbox{for}& r_0 & \le & \bar{r}_{ij} & < & r_1	\\[1.5ex]
-k_{dr}(\bar{r}_{ij}-r_1)\frac{\rvij}{r_{ij}}	
		&\mbox{for}& r_1 & \le & \bar{r}_{ij} & < & r_2	\\[1.5ex]
-k_{dr}(r_2-r_1)\frac{\rvij}{r_{ij}}	
		&\mbox{for}& r_2 & \le & \bar{r}_{ij} &   &
\end{array} \right.
\eeq
where $\bar{r}_{ij}$ is given by:
\beq
\bar{r}_{ij} ~=~ < r_{ij}^{-3} >^{-1/3}
\label{eqn:rav}
\eeq
Because of the time averaging we can no longer speak of a distance restraint
potential.

This way an atom can satisfy two incompatible distance restraints 
{\em on average} by moving between two positions. 
An example would be an amino-acid side-chain which is rotating around
its $\chi$ dihedral angle, thereby coming close to various other groups.
Such a mobile side chain may give rise to multiple NOEs, which can not be
fulfilled in a single structure.

The computation of the time
averaged distance in the {\tt mdrun} program is done in the following fashion:
\beq
\begin{array}{rcl}
\overline{r^{-3}}_{ij}(0) 	&=& r_{ij}(0)^{-3}	\\
\overline{r^{-3}}_{ij}(t)	&=& \overline{r^{-3}}_{ij}(t-\Delta t)~\exp{\left(-\frac{\Delta t}{\tau}\right)} + r_{ij}(t)^{-3}\left[1-\exp{\left(-\frac{\Delta t}{\tau}\right)}\right]
\label{eqn:ravdisre}
\end{array}
\eeq

When a pair is within the bounds it can still feel a force,
because the time averaged distance can still be beyond a bound.
To prevent the protons from being pulled too close together a mixed
approach can be used. In this approach the penalty is zero when the
instantaneous distance is within the bounds, otherwise the violation is
the square root of the product of the instantaneous violation and the 
time averaged violation.

\subsubsection{Averaging over multiple pairs} 

Sometimes it is unclear from experimental data which atom pair
gives rise to a single NOE, in other occasions it can be obvious that
more than one pair contributes due to the symmetry of the system, {\eg} a
methyl group with three protons. For such a group it is not possible 
to distinguish between the protons, therefore they should all be taken into
account when calculating the distance between this methyl group and another
proton (or group of protons).
Due to the physical nature of magnetic resonance, the intensity of the
NOE signal is proportional to the distance between atoms to the power of -6.
Thus, when combining atom pairs, 
a fixed list of $N$ restraints may be taken together, 
where the apparent ``distance'' is given by:
\beq
r_N(t) = \left [\sum_{n=1}^{N} \bar{r}_{n}(t)^{-6} \right]^{-1/6}
\label{eqn:rsix}
\eeq
where we use $r_{ij}$ or \eqnref{rav} for the $\bar{r}_{n}$.
The $r_N$ of the instantaneous and time-averaged distances
can be combined to do a mixed restraining as indicated above.
As more pairs of protons contribute to the same NOE signal, the intensity
will increase, and the summed ``distance'' will be shorter than any of
its components due to the reciprocal summation. 

There are two options for distributing the forces over the atom pairs.
In the conservative option the force is defined as the derivate of the
restraint potential with respect to the coordinates. This results in
a conservative potential when no time averaging is used.
The force distribution over the pairs is proportional to $r^{-6}$.
This means that a close pair feels a much larger force than a distant pair,
which might lead to a 'too rigid' molecule.
The other option is an equal force distribution. In this case each pair
feels $1/N$ of the derivative of the restraint potential with respect to 
$r_N$. The advantage of this method is that more conformations might be
sampled, but the non-conservative nature of the forces can lead to
local heating of the protons.

It is also possible to use {\em ensemble averaging} using multiple
(protein)  molecules. In this case the bounds should be lowered as in:
\beq
\begin{array}{rcl}
r_1     &~=~&   r_1 * M^{-1/6}  \\
r_2     &~=~&   r_2 * M^{-1/6}
\end{array}
\eeq
where $M$ is the number of molecules. The {\gromacs} preprocessor {\tt grompp}
can do this automatically when the appropriate option is given.
The resulting ``distance'' is 
then used to calculate the scalar force according to:
\beq
\begin{array}{rcl}
\ve{F}_i~=~&~0 \hspace{4cm}  & r_{N} < r_1         \\
  = ~&-~ k_{dr}(r_{N}-r_1)\frac{\rvij}{r_{ij}} & r_1 \le r_{N} < r_2 \\
  = ~&-~ k_{dr}(r_2-r_1)\frac{\rvij}{r_{ij}}    & r_{N} \ge r_2 
\end{array}
\eeq
where $i$ and $j$ denote the atoms of all the 
pairs that contribute to the NOE signal.

\subsubsection{Using distance restraints}

A list of distance restrains based on NOE data can be added to a molecule
definition in your topology file, like in the following example:
\begin{verbatim}
[ distance_restraints ]
; ai    aj      type    index   type'   low      up1     up2     fac
10      16      1       0       1       0.0      0.3     0.4     1.0 
10      28      1       1       1       0.0      0.3     0.4     1.0 
10      46      1       1       1       0.0      0.3     0.4     1.0 
16      22      1       2       1       0.0      0.3     0.4     2.5 
16      34      1       3       1       0.0      0.5     0.6     1.0 
\end{verbatim}
In this example a number of features can be found.  In columns {\tt
ai} and {\tt aj} you find the atom numbers of the particles to be
restrained. The {\tt type} column should always be 1.  As explained in
~\secref{disre}, multiple distances can contribute to a single NOE
signal. In the topology this can be set using the {\tt index}
column. In our example, the restraints 10-28 and 10-46 both have index
1, therefore they are treated simultaneously.  An extra requirement
for treating restraints together, is that the restraints should be on
successive lines, without any other intervening restraint.  The {\tt
type'} column will usually be 1, but can be set to 2 to obtain a
distance restraint which will never be time and ensemble averaged,
this can be useful for restraining hydrogen bonds.  The columns {\tt
low}, {\tt up1} and {\tt up2} hold the values of $r_0$, $r_1$ and
$r_2$ from ~\eqnref{disre}.  In some cases it can be useful to have
different force constants for some restraints, this is controlled by
the column {\tt fac}.  The force constant in the parameter file is
multiplied by the value in the column {\tt fac} for each restraint.

Some parameters for NMR refinement can be specified in the
{\tt grompp.mdp} file:
\begin{description}
\item[{\tt disre}: type of distance restraining.]
	The {\tt disre} variable sets the type of distance restraining.
	{\tt no/simple} turns the distance restraining off/on.
 	When multiple proteins or peptides are used
	in the simulation ensemble averaging 
	can be turned on by setting {\tt disre = ensemble}.
\item[{\tt disre\_weighting}: force-weighting in restraints with
	 multiple pairs.]
	The distance restraint force can be distributed equally
	over all the pairs involved in the restraint by setting
	{\tt disre\_weighting = equal}.
	The option {\tt disre\_weighting = conservative}
	gives conservative forces when {\tt disre\_tau = 0}.
\item[{\tt disre\_mixed}: how to calculate the violations.]
	{\tt disre\_mixed = no} gives normal time averaged violations.
	When {\tt disre\_mixed = yes} the square root of the
	product of the time averaged and the instantaneous
	violations is used.
\item[{\tt disre\_fc}: force constant $k_{dr}$ for distance restraints.] 
	$k_{dr}$  (\eqnref{disre}) can be set
	as variable {\tt disre\_fc = 1000} for a force constant of
	1000 {kJ mol$^{-1}$ nm$^{-2}$}. This value is multiplied by
	the value in the {\tt fac} column in the distance restraint
	entries in the topology file.
\item[{\tt disre\_tau}: time constant for restraints.] 
	$\tau$ (\eqnref{ravdisre}) can be set
	as variable {\tt disre\_tau = 10} for a time constant of
	10 ps. Time averaging can be turned off by setting {\tt disre\_tau}
	to 0.
\item[{\tt nstdisreout}: pair distance output frequency.]
	Determines how often the time averaged and 
	instantaneous distances of all atom pairs involved in
	distance restraints are written to the energy file.
\end{description}

\section{Free energy calculations}
\label{sec:fep}
\newcommand{\LAM}{\lambda}
\newcommand{\LL}{(1-\LAM)}
\newcommand{\dvdl}[1]{\frac{\partial #1}{\partial \LAM}}
\normindex{Free energy perturbation} calculations can be performed in
{\gromacs} using either the ``slow-growth'' method, or using umbrella sampling.
This requires modification of the Hamiltonian $H$, which can be derived
using the partition function $Z$.
If we write the Gibbs free energy $G$ using $Z$:
\bea
Z       &=&     \int \int \exp\left(-\beta H(p,q))\right) {\rm d}p {\rm d}q \\
G       &=&     -k_B T \ln Z
\eea
where $\beta$=$1/(k_B T)$ with $k_B$ Boltzmann's constant 
and $T$ the temperature.
$p$ are the generalized momenta and $q$ are the generalized coordinates.
We can split the Hamiltonian in the potential $V$ and kinetic $K$ parts:
\bea
H       &=&     V(q)    +       K(p)            \\
K(p)    &=&     \sum_i^N \frac{\ve{p}_i^2}{2 m_i}       
\eea
where $N$ is the number of particles in the system and $m_i$ are the masses
of the particles.
\beq
\begin{array}{rcl}
G &~=~& -1/\beta \ln \left[\int \exp(-\beta V(q)) dq \int \exp(-\beta K(p)) {\rm d}p  \right] \\
& \mbox{or} \\
G &~=~&   \left< K(p) \right> -1/\beta \ln \int \exp(-\beta V(q)) {\rm d}q
\end{array}
\eeq

Here are the modified equations used to calculate the free energy


\subsubsection{Harmonic potentials}
The example given here is for the bond potential which is harmonic
in {\gromacs}. However,  these equations apply to the angle potential
and the improper dihedral potential as well.
\bea
V_b     &=&\half(\LL k_b^A + 
                \LAM k_b^B) (b - \LL b_0^A - \LAM b_0^B)^2      \\
\dvdl{V_b}&=&\half(k_b^B-k_b^A)
                \left[b - \LL b_0^A + \LAM b_0^B)^2 + 
                      (b_0^A-b_0^B) (b - \LL b_0^A -\LAM b_0^B)\right]
                \nonumber\\
\eea

\subsubsection{Proper dihedrals}
For the proper dihedrals, the equations are somewhat more complicated:
\bea
V_d     &=&(\LL k_d^A + \LAM k_d^B) 
        ( 1+ \cos(n_{\phi} \phi - (\LL \phi_0^A + \LAM \phi_0^B)) \\
\dvdl{V_d}&=&(k_d^B-k_d^A) 
                \biggl[ 1+ \cos(n_{\phi} \phi- [\LL \phi_0^A + \LAM \phi_0^B])-\nonumber\\
        &&(\LL k_d^A + \LAM k_d^B) (\phi_0^A - \phi_0^B) 
        \sin(n_{\phi}\phi - [\LL \phi_0^A + \LAM \phi_0^B]\biggr]
\eea
{\bf Note:} that the multiplicity $n_{\phi}$ can not be parameterized
because the function should remain periodic on the interval $0..2\pi$.

\subsubsection{Coulomb interaction}
The \normindex{Coulomb} interaction between two particles 
of which the charge varies with $\LAM$ is:
\bea
V_c &=& \frac{f}{\epsrf \rij}\left[(\LL q_i^A+\LAM q_i^B)\cdot(\LL q_j^A+\LAM q_i^B)\right]     \\
\dvdl{V_c}&=& \frac{f}{\epsrf \rij}\left[(q_j^B-q_j^A)(\LL q_i^A+\LAM q_i^B)\,+\,
                        (q_i^B-q_i^A)(\LL q_j^A+\LAM q_j^B)\right]
\eea
where $f = \frac{1}{4\pi \varepsilon_0} = 138.935\,485$ (see \chref{defunits})

\subsubsection{Coulomb interaction with \normindex{Reaction Field}}
The coulomb interaction including a reaction field, between two particles 
of which the charge varies with $\LAM$ is:
\bea
V_c     &=& f\left[\frac{1}{\rij} + k_{rf}~ \rij^2 -c_{rf}\right]
        \left[(\LL q_i^A+\LAM q_i^B)\cdot(\LL q_j^A+\LAM q_i^B)\right]  \\
\dvdl{V_c}&=& f\left[\frac{1}{\rij} + k_{rf}~ \rij^2 -c_{rf}\right]\cdot\nonumber\\
        &~&\left[(q_j^B-q_j^A)(\LL q_i^A+\LAM q_i^B)\,+\,
                        (q_i^B-q_i^A)(\LL q_j^A+\LAM q_j^B)\right]
\eea
{\bf Note} that the constants $k_{rf}$ and $c_{rf}$ are 
defined using the dielectric 
constant $\epsrf$ of the medium (see \secref{coulrf}).

\subsubsection{Lennard-Jones interaction}
For the \normindex{Lennard Jones} interaction between two particles 
of which the {\em atom type} varies with $\LAM$ we can write:
\bea
V_{LJ}  &=&     \frac{(\LL C_{12}^A + \LAM C_{12}^B)}{\rij^{12}} -
                \frac{\LL C_6^A + \LAM C_6^B}{\rij^6}   \\
\dvdl{V_{LJ}}&=&\frac{C_{12}^B - C_{12}^A}{\rij^{12}} -
                \frac{C_6^B - C_6^A}{\rij^6}
\eea
It should be noted that it is also possible to express a pathway from
state $A$ to state $B$ using $\sigma$ and $\epsilon$ (see \eqnref{sigeps}).
It may seem to make sense  physically, to vary the forcefield parameters
$\sigma$ and $\epsilon$ rather 
than the derived parameters $C_{12}$ and $C_{6}$.
However, the difference between the pathways in parameter space
is not large, and the free energy itself
does not depend on the pathway, therefore we use the simple formulation
presented above.

\subsection{Near linear thermodynamic integration}
In {\gromacs} the near linear thermodynamic integration (NLTI) method of Resat 
and Mezei has been implemented~\cite{Resat93}. This method avoids singularities
at the end points of the TI calculation ({$\LAM$} = 0, or 1) for the case of 
creation or annihilation of particles. State B should the correspond to no particle.
The modified equations for the Lennard-Jones contribution are:
\bea
V_{LJ}  &=&     \frac{(\LL^4 C_{12}^A + \LAM^4 C_{12}^B)}{\rij^{12}} \,-\,
                \frac{\LL^3 C_6^A + \LAM^3 C_6^B}{\rij^6}       \\
\dvdl{V_{LJ}}&=&4\,\frac{\LAM^3 C_{12}^B - \LL^3 C_{12}^A}{\rij^{12}} \,-\,
                3\,\frac{\LAM^2 C_6^B - \LL^2 C_6^A}{\rij^6}
\eea
It can be seen immediately that when $C_{12}^B = C_6^B = 0$ (no particle) and
$\LAM$ = 1, both $V_{LJ}$ and $\dvdl{V_{LJ}}$ are zero. (This means they need not 
be evaluated either).
For the coulomb contribution we have:
\bea
V_c &=& \frac{f}{\epsrf \rij}\left[(\LL^2 q_i^A+\LAM^2 q_i^B)\,(\LL^2 q_j^A+\LAM^2 q_i^B)\right]        \\
\dvdl{V_c}&=& 2\,\frac{f}{\epsrf \rij}[(\LAM q_j^B-\LL q_j^A)(\LL^2 q_i^A+\LAM^2 q_i^B)\,+\,\\\nonumber
        &~ &            (\LAM q_i^B-\LL q_i^A)(\LL^2 q_j^A+\LAM^2 q_j^B)]
\eea
Resat and Mezei have tested which exponents to $\LAM$ resp. $\LL$ are best and found
that 4 for the repulsion, 3 for the dispersion and 2 for the Coulomb interaction to
give good results~\cite{Resat93}.

Although this method is an improvement over linear scaling, for small $\LAM$ there
still can be large forces and/or energies, and therefore careful equilibration 
should be done.

\subsubsection{Kinetic Energy}
When the mass of a particle changes there is also a contribution of
the kinetic energy to the free energy (note that we can not write 
the momentum \ve{p} as m\ve{v} since that would result 
in the sign of $\dvdl{Ek}$ being incorrect~\cite{Gunsteren98a}):

\bea
Ek      &=&     \half\frac{\ve{p}^2}{\LL m^A + \LAM m^B}        \\
\dvdl{Ek}&=&    -\half\frac{\ve{p}^2(m^B-m^A)}{(\LL m^A + \LAM m^B)^2}
\eea
after taking the derivative, we {\em can} insert \ve{p} = m\ve{v}, such that:
\beq
\dvdl{Ek}~=~    -\half\ve{v}^2(m^B-m^A)
\eeq

\subsubsection{Constraints}
\newcommand{\clam}{C_{\lambda}}
The constraints are formally part of the Hamiltonian, and therefore
they give a contribution to the free energy. In {\gromacs} this can be
calculated using the \normindex{LINCS} algorithm only.
If we have a number of constraint equations $g_k$:
\beq
g_k     =       r_{k} - d_{k}
\eeq
where $\ve{r}_k$ is the distance vector between two particles and 
$d_k$ is the constraint distance between the two particles we can write
this using a $\LAM$ dependent distance as
\beq
g_k     =       r_{k} - \left(\LL d_{k}^A + \LAM d_k^B\right)
\eeq
the contribution $\clam$ 
to the Hamiltonian using Lagrange multipliers $\lambda$:
\bea
\clam           &=&     \sum_k \lambda_k g_k    \\
\dvdl{\clam}    &=&     \sum_k \lambda_k \left(d_k^B-d_k^A\right)
\eea


\section{Methods}
\subsection{Exclusions and 1-4 Interactions.}
Atoms within a molecule that are close by in the chain, 
{\ie} atoms that are covalently bonded, or linked by one respectively two
atoms are so-called {\em first neighbors, second neighbors} and 
{\em \normindex{third neighbors}}, (see \figref{chain}). Since the
interactions of atom {\bf i} with {\bf i+1} 

\begin{figure}
\centerline{\psfig {figure=plots/chain.eps,angle=270,width=8cm}}
\caption{Atoms along an alkane chain.}
\label{fig:chain}
\end{figure}

and the interaction of atom {\bf i} with atom {\bf i+2} are mainly
quantum mechanical, they can not be modeled by a Lennard-Jones potential.
Instead it is assumed that these interactions are adequately modeled
by a harmonic bond term or constraint ({\bf i,i+1}) and a harmonic angle term
({\bf i,i+2}). The first and second neighbors (atoms {\bf i+1}and {\bf i+2}) 
are therefore
{\em excluded} from the Lennard-Jones \normindex{interaction list} 
of atom {\bf i};
atoms {\bf i+1} and {\bf i+2} are called {\em \normindex{exclusions}} of atom {\bf i}.

For third neighbors the normal Lennard-Jones repulsion is sometimes
still too strong, which means that when applied to a molecule the
molecule would deform or break due to the internal strain. This is
especially the case for Carbon-Carbon interactions in a {\em
cis}-conformation ({\eg} {\em cis}-butane).  Therefore for some of these
interactions the Lennard-Jones repulsion has been reduced in the
{\gromos} force field, which is implemented by keeping a separate list of
1-4 and normal Lennard-Jones parameters. In other force fields, such
as OPLS~\cite{Jorgensen88}, the standard Lennard-Jones parameters are reduced
by a factor of two, but in that case also the dispersion (r$^{-6}$)
and the coulomb interaction are scaled.
{\gromacs} can use either of these methods.

\subsection{Charge Groups.}
\label{sec:cg}
In principle the force calculation in MD is an $O(N^2)$ problem.
Therefore we apply a \normindex{cut-off} for non-bonded force (NBF)
calculations: only the particles within a certain distance of each
other are interacting. This reduces the cost to $O(N)$ (typically
$100N$ to $200N$) of the NBF. It also introduces an error, which is,
in most cases, acceptable, except when applying the cut-off implies
the creation of charges, in which case you should consider using the
lattice sum methods provided by {\gromacs}.

Consider a water molecule interacting with another atom. When we would apply
the cut-off on an atom-atom basis we might include the atom-Oxygen
interaction (with a charge of -0.82) without the compensating charge
of the Hydrogens and so induce a large dipole moment over the system.
Therefore we have to keep groups of atoms with total charge
0 together, the so-called {\em charge groups}.

\input{cutoff}

\newcommand{\Fi}{\ve{F}_i'}
\newcommand{\Fj}{\ve{F}_j'}
\newcommand{\Fk}{\ve{F}_k'}
\newcommand{\Fl}{\ve{F}_l'}
\newcommand{\Fdum}{\ve{F}_{d}}
\newcommand{\rvik}{\ve{r}_{ik}}
\newcommand{\rvid}{\ve{r}_{id}}
\newcommand{\rvjk}{\ve{r}_{jk}}
\newcommand{\rvjl}{\ve{r}_{jl}}

\section{Dummy atoms.}
\label{sec:dummy}
\normindex{Dummy atom}s can be used in {\gromacs} in a number of ways. 
We write the position of the dummy particle $\ve{r}_d$ as a function of
the positions of other particles \ve{r}$_i$: $\ve{r}_d =
f(\ve{r}_1..\ve{r}_n)$. The dummy, which may carry charge, or can be
involved in other interactions can now be used in the force
calculation.  The force acting on the dummy particle must be
redistributed over the atoms in a consistent way. A good way to do
this can be found in ref.~\cite{Berendsen84b}.  We can write the
potential energy as
\beq
V = V(\ve{r}_d,\ve{r}_1..\ve{r}_n) = V^*(\ve{r}_1..\ve{r}_n)
\eeq
The force on the particle $i$ is then
\beq
\ve{F}_i = -\frac{\partial V^*}{\partial \ve{r}_i} 
         = -\frac{\partial V}{\partial \ve{r}_i} - 
            \frac{\partial \ve{r}_d}{\partial \ve{r}_i}
            \frac{\partial V}{\partial \ve{r}_d} 
         = \ve{F}_i^{direct} + \Fi
\eeq
the first term of which is the normal force. 
The second term is the force on particle $i$ due to the dummy particle, which
can be written in tensor notation:
\newcommand{\partd}[2]{\displaystyle\frac{\partial #1}{\partial #2_i}}
\beq
\Fi = \left[\begin{array}{ccc}
\partd{x_d}{x} & \partd{y_d}{x} & \partd{z_d}{x}        \\[1ex]
\partd{x_d}{y} & \partd{y_d}{y} & \partd{z_d}{y}        \\[1ex]
\partd{x_d}{z} & \partd{y_d}{z} & \partd{z_d}{z}
\end{array}\right]\Fdum
\eeq
where $\Fdum$ is the force on the dummy particle and $x_d$, $y_d$ and
$z_d$ are the coordinates of the dummy particle. In this way the total
force and the total torque are conserved~\cite{Berendsen84b}.

\begin{figure}
\centerline{\psfig{figure=plots/dummies.eps,width=15cm}}
\caption[Dummy atom construction.]{The six different types of dummy
atom construction in \protect{\gromacs}, the constructing atoms are
shown as black circles, the dummy atoms in grey.}
\label{fig:dummies}
\end{figure}

There are six ways to construct dummies from surrounding atoms in
{\gromacs}, which we categorize based on the number of constructing
atoms. Note that all dummies types mentioned can be constructed from
types 3fd (normalized, in-plane) and 3out (non-normalized, out of
plane). However, the amount of computation involved increases sharply
along this list, so it is strongly recommended to always use the first
dummy type that will be sufficient for a certain purpose. An overview
of the dummy constructions is given in \figref{dummies}.

\begin{itemize}
\item[2.]As a linear combination of two atoms
        (\figref{dummies} 2):
\beq
        \ve{r}_d ~=~ \ve{r}_i + a \rvij
\eeq
        in this case the dummy is on the line through atoms $i$ and
        $j$. The force on particles $i$ and $j$ due to the force on
        the dummy can be computed as:
\beq
        \begin{array}{lcr}
        \Fi &=& (1-a)\Fdum      \\
        \Fj &=& a\,\Fdum        \\
        \end{array}
\eeq

\item[3.]As a linear combination of three atoms
        (\figref{dummies} 3):
\beq
        \ve{r}_d ~=~ \ve{r}_i + a \rvij + b \rvik
\eeq
        in this case the dummy is in the plane of the other three particles.
        The force on particles $i$, $j$ and $k$ due to the force on the dummy
        can be computed as:
\beq
        \begin{array}{lcr}
        \Fi &=& (1-a-b)\Fdum    \\
        \Fj &=& a\,\Fdum        \\
        \Fk &=& b\,\Fdum        \\
        \end{array}
\eeq

\item[3fd.]In the plane of three atoms, with a fixed distance
        (\figref{dummies} 3fd):
\beq
        \ve{r}_d ~=~ \ve{r}_i + b \frac{  \rvij + a \rvjk  }
                                     {| \rvij + a \rvjk |}      
\eeq
        in this case the dummy is in the plane of the other three
        particles at a distance of $|b|$ from $i$.
        The force on particles $i$, $j$ and $k$ due to the force on the dummy
        can be computed as:
\beq
        \begin{array}{lcr}
        \Fi &=& \displaystyle \Fdum - \gamma ( \Fdum - \ve{p} ) \\[1ex]
        \Fj &=& \displaystyle (1-a)\gamma (\Fdum - \ve{p})      \\[1ex]
        \Fk &=& \displaystyle a \gamma (\Fdum - \ve{p})         \\
        \end{array}
        ~\mbox{~ where~ }~
        \begin{array}{c}
\displaystyle \gamma = \frac{b}{| \rvij + a \rvjk |} \\[2ex]
\displaystyle \ve{p} = \frac{ \rvid \cdot \Fdum }
                      { \rvid \cdot \rvid } \rvid
        \end{array}
\eeq

\item[3fad.]In the plane of three atoms, with a fixed angle and
        distance (\figref{dummies} 3fad):
\beq
\label{eqn:dum2fad-F}
         \ve{r}_d ~=~ \ve{r}_i +
                    d \cos \theta \frac{\rvij}{|\rvij|} +
                    d \sin \theta \frac{\ve{r}_\perp}{|\ve{r}_\perp|}
        ~\mbox{~ where~ }~
        \ve{r}_\perp ~=~ \rvjk - 
                        \frac{ \rvij \cdot \rvjk }
                             { \rvij \cdot \rvij }
                         \rvij
\eeq
        in this case the dummy is in the plane of the other three
        particles at a distance of $|d|$ from $i$ at an angle of
        $\alpha$ with $\rvij$. Atom $k$ defines the plane and the
        direction of the angle. Note that in this case $b$ and
        $\alpha$ must be specified in stead of $a$ and $b$ (see also
        \secref{dummytop}). The force on particles $i$, $j$ and $k$
        due to the force on the dummy can be computed as (with
        $\ve{r}_\perp$ as defined in \eqnref{dum2fad-F}):
\newcommand{\dfrac}{\displaystyle\frac}
\beq
\begin{array}{c}
        \begin{array}{lclllll}
        \Fi &=& \Fdum &-& 
                \dfrac{d \cos \theta}{|\rvij|} \ve{F}_1 &+&
                \dfrac{d \sin \theta}{|\ve{r}_\perp|} \left( 
                \dfrac{ \rvij \cdot \rvjk }
                     { \rvij \cdot \rvij } \ve{F}_2     +
                \ve{F}_3 \right)                                \\[3ex]
        \Fj &=& &&
                \dfrac{d \cos \theta}{|\rvij|} \ve{F}_1 &-&
                \dfrac{d \sin \theta}{|\ve{r}_\perp|} \left(
                 \ve{F}_2 + 
                 \dfrac{ \rvij \cdot \rvjk }
                        { \rvij \cdot \rvij } \ve{F}_2 +
                \ve{F}_3 \right)                                \\[3ex]
        \Fk &=& && &&
                \dfrac{d \sin \theta}{|\ve{r}_\perp|} \ve{F}_2  \\[3ex]
        \end{array}                                             \\[5ex]
        \mbox{where ~}
        \ve{F}_1 = \Fdum -
                  \dfrac{ \rvij \cdot \Fdum }
                        { \rvij \cdot \rvij } \rvij
        \mbox{\,, ~}
        \ve{F}_2 = \ve{F}_1 -
                  \dfrac{ \ve{r}_\perp \cdot \Fdum }
                        { \ve{r}_\perp \cdot \ve{r}_\perp } \ve{r}_\perp
        \mbox{~and ~}
        \ve{F}_3 = \dfrac{ \rvij \cdot \Fdum }
                         { \rvij \cdot \rvij } \ve{r}_\perp
\end{array}
\eeq

\item[3out.]As a non-linear combination of three atoms, out of plane
        (\figref{dummies} 3out):
\beq
        \ve{r}_d ~=~ \ve{r}_i + a \rvij + b \rvik +
                c (\rvij \times \rvik)
\eeq
        this enables the construction of dummies out of the plane of the
        other atoms.
        The force on particles $i,j$ and $k$ due to the force on the dummy
        can be computed as:
\beq
\begin{array}{lcl}
\vspace{4mm}
\Fj &=& \left[\begin{array}{ccc}
 a              &  -c\,z_{ik}   & c\,y_{ik}     \\[0.5ex]
 c\,z_{ik}      &   a           & -c\,x_{ik}    \\[0.5ex]
-c\,y_{ik}      &   c\,x_{ik}   & a
\end{array}\right]\Fdum                                 \\
\vspace{4mm}
\Fk &=& \left[\begin{array}{ccc}
 b              &   c\,z_{ij}   & -c\,y_{ij}    \\[0.5ex]
-c\,z_{ij}      &   b           & c\,x_{ij}     \\[0.5ex]
 c\,y_{ij}      &  -c\,x_{ij}   & b
\end{array}\right]\Fdum                                 \\
\Fi &=& \Fdum - \Fj - \Fk
\end{array}
\eeq

\item[4fd.]From four atoms, with a fixed distance
        (\figref{dummies} 4fd):
\beq
        \ve{r}_d ~=~ \ve{r}_i + c \frac{  \rvij + a \rvjk + b \rvjl }
                                     {| \rvij + a \rvjk + b \rvjl|}     
\eeq
        in this case the dummy is at a distance of $|c|$ from $i$.
        The force on particles $i$, $j$, $k$ and $l$ due to the force 
        on the dummy can be computed as:
\beq
        \begin{array}{lcr}
        \Fi &=& \displaystyle \Fdum - \gamma ( \Fdum - \ve{p} ) \\[1ex]
        \Fj &=& \displaystyle (1-a-b)\gamma (\Fdum - \ve{p})    \\[1ex]
        \Fk &=& \displaystyle a \gamma (\Fdum - \ve{p})         \\[1ex]
        \Fl &=& \displaystyle b \gamma (\Fdum - \ve{p})         \\
        \end{array}
        ~\mbox{~ where~ }~
        \begin{array}{c}
\displaystyle \gamma = \frac{c}{| \rvij + a \rvjk + b \rvjl |} \\[2ex]
\displaystyle \ve{p} = \frac{ \rvid \cdot \Fdum }
                      { \rvid \cdot \rvid } \rvid
        \end{array}
\eeq


\end{itemize}

\input{lr_elstat}


\section{\normindex{All-hydrogen forcefield}}
The {\gromacs} all-hydrogen forcefield is almost identical to the normal
{\gromacs} forcefield, since the extra hydrogens have no Lennard-Jones
interaction and zero charge. The only differences are in the bond angle
and improper dihedral angle terms. This forcefield is only useful when
you need the exact hydrogen positions, for instance for distance
restraints derived from NMR measurements.

\section{\gromosv{96} notes}

\subsection{The \gromosv{96} force field\index{gromos-96 force field}}
{\gromacs} supports the \gromosv{96} force fields~\cite{gromos96}.
All parameters for the 43a1, 43a2 (development, improved alkane
dihedrals) and 43b1 (vacuum) force fields are included.  All standard
building blocks are included and topologies can be build automatically
by {\tt pdb2gmx}.  The \gromosv{96} force field is a further
development of the \gromosv{87} force field on which the {\gromacs}
forcefield is based. The \gromosv{96} force field has improvements
over the {\gromacs} force field for proteins and small molecules.
It is, however, not recommended to be used for long alkanes and
lipids.  The \gromosv{96} force field differs from the {\gromacs}
force field in a few aspects:
\begin{itemize}
\item the force field parameters
\item the parameters for the bonded interactions are not linked to atom types
\item a fourth power bond stretching potential (\secref{bondpot})
\item an angle potential based on the cosine of the angle (\secref{anglepot})
\end{itemize}
There are two differences in implementation between {\gromacs} and \gromosv{96}
which can lead to slightly different results when simulating the same system
with both packages: 
\begin{itemize}
\item in \gromosv{96} neighbor searching for solvents is performed on the
first atom of the solvent molecule, this is not implemented in {\gromacs},
but the difference with searching with centers of charge groups is very small
\item the virial in \gromosv{96} is molecule based, this is not implemented in
{\gromacs}, which uses atomic virials
\end{itemize}
The \gromosv{96} force field was parameterized with a Lennard-Jones cut-off
of 1.4 nm, so be sure to use a Lennard-Jones cut-off of at least 1.4.
A larger cut-off is possible, because the Lennard-Jones potential and forces
are almost zero beyond 1.4 nm.

\subsection{\gromosv{96} files\index{gromos-96 files}}
{\gromacs} can read and write \gromosv{96} coordinate and trajectory files.
These files should have the extension {\tt .g96}.
Such a file can be a \gromosv{96} initial/final
configuration file or a coordinate trajectory file or a combination of both.
The file is fixed format, all floats are written as 15.9 (files can get huge).
{\gromacs} supports the following data blocks in the given order:
\begin{itemize}
\item Header block:
\begin{verbatim}
TITLE (mandatory)
\end{verbatim}
\item Frame blocks:
\begin{verbatim}
TIMESTEP (optional)
POSITION/POSITIONRED (mandatory)
VELOCITY/VELOCITYRED (optional)
BOX (optional)
\end{verbatim}
\end{itemize}
See the \gromosv{96} manual~\cite{gromos96} for a complete description of the
blocks. Note that all {\gromacs} programs can read compressed or g-zipped files.
